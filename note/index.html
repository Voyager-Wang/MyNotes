<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="记录工作和学习文档">
    
    
    <link rel="shortcut icon" href="../img/favicon.ico">

    
    <title>Note - 我的笔记</title>
    

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/v4-shims.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css">
    <link href='//rsms.me/inter/inter.css' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="../css/base.min.css" rel="stylesheet">
    <link href="../css/cinder.min.css" rel="stylesheet">

    
        
        <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/styles/github.min.css">
        
    

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    

     
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            
              <a class="navbar-brand" href="..">我的笔记</a>
            
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../keymap/">快捷方式</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">文章 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">大数据</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E5%A4%A7%E6%95%B0%E6%8D%AE/alluxio/">Alluxio</a>
</li>

        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E5%A4%A7%E6%95%B0%E6%8D%AE/hudi/">Hudi</a>
</li>

        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E5%A4%A7%E6%95%B0%E6%8D%AE/spark-streaming/">Spark</a>
</li>

        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E5%A4%A7%E6%95%B0%E6%8D%AE/yarn/">Yarn</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">数据库</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%80%E6%9C%AF/Canal%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">Canal</a>
</li>

        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%80%E6%9C%AF/LogMiner/">LogMinor</a>
</li>

        
            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">MySQL</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%80%E6%9C%AF/MySQL%20GTID%20set%E5%A4%84%E7%90%86%E6%8A%80%E6%9C%AF/">GTID</a>
</li>

        
    </ul>
  </li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">日记</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E6%97%A5%E8%AE%B0/A-Voyager_%E8%B5%B7%E8%88%AA/">起航</a>
</li>

        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E6%97%A5%E8%AE%B0/Diary-%E8%88%AA%E8%A1%8C%E6%97%A5%E5%BF%97/">航行日志</a>
</li>

        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E6%97%A5%E8%AE%B0/Engine-1_%E5%86%A5%E6%83%B3%E4%BD%93%E6%82%9F/">Engine1-冥想</a>
</li>

        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E6%97%A5%E8%AE%B0/Engine-3_%E5%B1%80%E5%A4%96%E4%BA%BA/">Engine3-局外人</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">java <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../%E6%96%87%E7%AB%A0/java%E6%8A%80%E6%9C%AF/idea/">IDEA</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../ToDo/">ToDo</a>
                    </li>
                
                
                
                    <li >
                        <a href="https://github.com/arcticXXX">GitHub</a>
                    </li>
                
                
                </ul>

            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#kill-connection">Kill Connection</a></li>
        <li class="first-level "><a href="#_1">支持报警组</a></li>
        <li class="first-level "><a href="#insert-ignore">INSERT IGNORE</a></li>
        <li class="first-level "><a href="#_2">参数采集</a></li>
            <li class="second-level"><a href="#_3">全量同步</a></li>
                
            <li class="second-level"><a href="#_4">增量同步</a></li>
                
            <li class="second-level"><a href="#_5">订阅</a></li>
                
            <li class="second-level"><a href="#ndc">NDC存在的几个问题</a></li>
                
                <li class="third-level"><a href="#1ndc">1.对用户来说，NDC形态上和数据库的元数据联系还不够紧密</a></li>
                <li class="third-level"><a href="#2binlog">2.历史数据的追溯依赖源端数据库binlog的管理</a></li>
                <li class="third-level"><a href="#3">3.不能做到跨节点的一拉多推</a></li>
        <li class="first-level "><a href="#_6">整合元数据中心流表</a></li>
            <li class="second-level"><a href="#_7">一、需求</a></li>
                
                <li class="third-level"><a href="#1-">解决痛点1--平台打通:</a></li>
                <li class="third-level"><a href="#2-">解决痛点2--新的序列化方式:</a></li>
            <li class="second-level"><a href="#ndc_1">二、方案（NDC平台）</a></li>
                
                <li class="third-level"><a href="#1-ndc">1.平台打通--NDC接口概述</a></li>
                <li class="third-level"><a href="#2">2.新的序列化方式</a></li>
                <li class="third-level"><a href="#dbhub">DBHub表配置参数说明：</a></li>
                <li class="third-level"><a href="#dbhub_1">DBHub表运行信息说明：</a></li>
            <li class="second-level"><a href="#1ndc_1">1.NDC功能点概括</a></li>
                
            <li class="second-level"><a href="#2_1">2.数据迁移改造流程</a></li>
                
                <li class="third-level"><a href="#21">2.1 改造前：表结构修改</a></li>
                <li class="third-level"><a href="#22">2.2 改造中：单元化改造方案</a></li>
                <li class="third-level"><a href="#23">2.3 改造后：数据校验</a></li>
            <li class="second-level"><a href="#3_1">3.表结构变更</a></li>
                
                <li class="third-level"><a href="#31">3.1 新增字段（支持）</a></li>
                <li class="third-level"><a href="#32">3.2 删除字段（支持）</a></li>
                <li class="third-level"><a href="#33">3.3 修改字段类型（支持）</a></li>
                <li class="third-level"><a href="#34">3.4 修改字段名（不支持）</a></li>
                <li class="third-level"><a href="#35">3.5 修改字段顺序</a></li>
                <li class="third-level"><a href="#36">3.6 增删索引</a></li>
            <li class="second-level"><a href="#4ddb">4.DDB扩容缩容</a></li>
                
            <li class="second-level"><a href="#5">5.故障处理</a></li>
                
                <li class="third-level"><a href="#51">5.1 数据库主从切换</a></li>
                <li class="third-level"><a href="#52">5.2 其他待补充</a></li>
            <li class="second-level"><a href="#6">6.异常数据处理</a></li>
                
            <li class="second-level"><a href="#_8">性能分析功能</a></li>
                
            <li class="second-level"><a href="#_9">监控参数</a></li>
                
                <li class="third-level"><a href="#puller">Puller监控参数</a></li>
                <li class="third-level"><a href="#_10">任务监控参数</a></li>
                <li class="third-level"><a href="#_11">全量同步</a></li>
                <li class="third-level"><a href="#_12">增量同步</a></li>
                <li class="third-level"><a href="#_13">订阅（增量推送）</a></li>
            <li class="second-level"><a href="#20213">数据库单元化成果和后续落地规划（2021年3月）：</a></li>
                
                <li class="third-level"><a href="#_14">概述</a></li>
                <li class="third-level"><a href="#_16">后续计划</a></li>
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h2 id="kill-connection">Kill Connection<a class="headerlink" href="#kill-connection" title="Permanent link">&para;</a></h2>
<p>当前kill connection的逻辑</p>
<p>kill connection是为了避免双跑而引入的机制</p>
<p>触发kill Connection有两个时机：</p>
<ul>
<li>1.启动任务时：dispitch任务之前</li>
<li>2.任务高可用时：涉及到比较特殊的逻辑，如果任务的connId == -1，将不能进行高可用</li>
</ul>
<p>对于运行在一拉多推方式下的任务，由于任务进程没有自己的增量connId，因此将puller进程的connId设置为任务的connId，启动任务时，对这种情况（任务运行在一拉多推方式下，且任务处于Init，Pending或者Stopped状态）做了特殊处理，不会去kill puller的connection</p>
<p>漏洞在于，如果将任务的拉取方式由一拉多推改为单拉单推，任务已经和原来的puller没有关系，但是这时启动任务时，由于不符合上述情况，会将原来puller的connection强制kill，影响到puller上的其他任务，这显然是不合理的。</p>
<p>因此，如果任务的拉取方式由一拉多推改为单拉单推（只能在任务未下发状态下执行），需要将原来保存的puller的connId清空，避免出现上述问题</p>
<h2 id="_1">支持报警组<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>需求列表整理：</p>
<ul>
<li>[x] 项目中包含报警组</li>
<li>[x] 一个用户可以属于多个报警组</li>
<li>[x] 报警组只能包含项目中的用户</li>
<li>[x] 项目管理员可以查看项目内所有报警组</li>
<li>[x] 项目管理员可以创建报警组</li>
<li>[x] 项目管理员可以修改报警组</li>
<li>[x] 项目管理员可以删除报警组</li>
<li>[ ] 报警组内的成员可以修改报警组</li>
<li>[ ] 报警组内的成员可以删除报警组</li>
<li>[ ] 普通用户可以定义报警组</li>
<li>[ ] 普通用户可以修改报警组</li>
<li>[ ] 普通用户可以删除报警组</li>
<li>[ ] 所有用户可以查看某个用户属于哪些报警组</li>
<li>[x] 报警模版可以添加报警组</li>
<li>[x] 报警组修改后，对所有报警模版都生效</li>
<li>[x] 任务的报警人可以添加报警组</li>
<li>[ ] 报警组移除后，从所有报警模版和任务报警人中移除</li>
<li>[x] 报警组修改后，对所有任务都生效</li>
<li>[ ] 用户从项目中移除时，从报警组中移除</li>
</ul>
<p>curl -H &ldquo;Content-Type: application/json&rdquo; http://hadoop334.photo.163.org:8765/v1/groups -d &ldquo;{
    "name": "wangtao_test_group",
    "product": &ldquo;ndc_test"}&rdquo;</p>
<p>curl -H &ldquo;Content-Type: application/json&rdquo; http://hadoop334.photo.163.org:8765/v1/groups -d &ldquo;{
    "name": "wangtao_test_group",
    "product": "ndc_test"}&rdquo;</p>
<p>curl -H &ldquo;Content-Type: application/json&rdquo; http://hadoop334.photo.163.org:8765/v1/groups/218 -X DELETE</p>
<p>curl http://hadoop334.photo.163.org:8765/v1/groups</p>
<p>报警组交给猛犸报警平台维护，ndc不保存报警组的元数据</p>
<p>ndc发送报警时只需要指定报警组id即可</p>
<p>为了展示更直观，ndc任务除了保存报警组id，还保存报警组的名称</p>
<p>猛犸平台报警组名称是可变的，因此ndc任务保存的报警组名称和猛犸可能有出入，不过这仅仅是显示问题，不影响报警的发送。</p>
<p>如果猛犸报警平台的报警组被删除了，ndc任务中的保存的报警组不会被删除，修改任务时会将改报警组标红，提示用户报警组已经不存在了</p>
<p>待确认：ndc发送报警时指定了一个不存在的报警组id，报警可以正常发送，该id会被忽略</p>
<p>报警组是一个可扩展的功能，可以对接其他支持报警组功能的系统，使用猛犸报警系统时，限制只能发送给OpenId登录的用户</p>
<p>ndc界面上支持报警组的创建、配置（只能修改报警组的成员和描述信息）、删除</p>
<h2 id="insert-ignore">INSERT IGNORE<a class="headerlink" href="#insert-ignore" title="Permanent link">&para;</a></h2>
<p>review：</p>
<p>INSERT IGNORE会产生三个作用：</p>
<p>1.Rows that duplicate an existing row on a unique key value are discarded</p>
<p>这是我们期望INSERT IGNORE完成的事情，但是如果目标端已有第三方写入的数据，可能会造成数据不一致；或者源端DDB，多个表写入一张表的场景下，如果存在重复的数据，也会出现数据不一致</p>
<p>2.Rows set to values that would cause data conversion errors are set to the closest valid values instead</p>
<p>这会造成一些意料之外的数据不一致，比如向int not null字段插入null，会自动转化成0，而不是报错（INSERT IGNORE具有很高的优先级，会忽略数据库的Strict SQL Mode配置）</p>
<p>3.For partitioned tables where no partition matching a given value is found, <code>IGNORE</code> causes the insert operation to fail silently for rows containing the unmatched value</p>
<p>也会引入数据丢失</p>
<p>第二种和第三种情况下出现数据不一致，相对比较容易排查，可以通过表结构、分区情况来排查，<strong>第一种情况比较难排查，建议增加日志，如果INSERT IGNORE 的affect rows少于预期，则打印WARN，方便在出现数据不一致场景时，确实是否是INSERT IGNORE引入的。</strong></p>
<h2 id="_2">参数采集<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>配置参数：开启性能分析（默认不开启），可以在任务运行中开启或关闭</p>
<p>性能分析开启后，会增加统计功能，并打印statistic日志，前端”运行信息“的“全量同步”“增量同步”“增量推送”标签栏中会增加”性能分析“，点击后可以查看性能相关的运行参数</p>
<p>性能相关的运行参数包含三种：</p>
<ul>
<li>配置参数：任务隐含的一些配置，不会随时间变化</li>
<li>瞬时参数：可以在某一确定时刻获取的参数，如活跃线程数</li>
<li>统计参数：需要在一段时间里统计得到的参数（默认20s），比如速度</li>
</ul>
<h3 id="_3">全量同步<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p><strong>select&ndash;&gt;queue&ndash;&gt;insert</strong></p>
<ul>
<li>
<p>已有参数：全量执行速度 行/s</p>
</li>
<li>
<p>select 平均执行时间 ns：确认是否有慢查询，帮助确认batch设置是否合理</p>
</li>
<li>
<p>select 速度上限 行/s：不考虑等待insert引起的损失，确认调整select参数的效果</p>
</li>
<li>
<p>insert 平均执行时间 ns：确认insert的执行是否存在瓶颈</p>
</li>
<li>insert 速度上限 行/s：不考虑等待select引起的损失，确认调整insert参数的效果</li>
<li>select 活跃线程数：真正使用的线程数</li>
<li>
<p>insert 活跃线程数：真正使用的线程数</p>
</li>
<li>
<p>select 线程空闲率 %：在使用的线程有多少时间用于等待queue</p>
</li>
<li>
<p>insert 线程空闲率 %：在使用的线程有多少时间用于等待queue</p>
</li>
<li>
<p>冲突数据处理 行/s：全量速度比较慢时，确认是否时因为目标端存在大量冲突数据</p>
</li>
</ul>
<h3 id="_4">增量同步<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p><strong>extract&ndash;&gt;eventGraph&ndash;&gt;applyWorker</strong></p>
<ul>
<li>
<p>已有参数：同步速度 行/s</p>
</li>
<li>
<p>解析速度上限 行/s：确认解析是否是瓶颈</p>
</li>
<li>解析性能余量%：100% - 解析时间占extract总处理时间的比例</li>
<li>系统性能余量 %：等待MySQL发送binlog的时间占整个extract处理时间的比例</li>
<li>apply 活跃线程数：真正使用的线程数，确认增大并发是否有作用，以及发现挂掉的线程？</li>
<li>apply 速度上限 行/s：确认瓶颈是否在apply，确认调整apply参数的效果</li>
<li>事务平均大小 行：确认批量行级的效果</li>
<li>apply 平均事务执行时间 ns：</li>
<li>apply 线程空闲率 %：在使用的线程有多少时间用于等待eventGraph</li>
<li>缓存容量：eventGraph可以容纳的event个数</li>
<li>缓存用量 %：eventGraph的event个数与上限的比例</li>
<li>待执行event个数：eventGraph的slaveQueue中的event个数，帮助确认瓶颈在apply</li>
<li>冲突数据比例 %：100% - eventGraph中indepenent event占的比例</li>
</ul>
<h3 id="_5">订阅<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p><strong>extract&ndash;&gt;apply</strong></p>
<ul>
<li>推送速度 行/s</li>
<li>解析速度上限 行/s：确认解析是否是瓶颈</li>
<li>解析性能余量%：100% - 解析时间占extract总处理时间的比例</li>
<li>系统性能余量 %：等待MySQL发送binlog的时间占整个extract处理时间的比例</li>
<li>推送消息平均时间 ns：写入单个消息花费的平均时间</li>
<li>推送消息速度上限 event/s：写入消息队列的理论速度上限</li>
</ul>
<h3 id="ndc">NDC存在的几个问题<a class="headerlink" href="#ndc" title="Permanent link">&para;</a></h3>
<h4 id="1ndc">1.对用户来说，NDC形态上和数据库的元数据联系还不够紧密<a class="headerlink" href="#1ndc" title="Permanent link">&para;</a></h4>
<p>NDC确实已经提供了流式访问数据库增量数据的能力，但是这个方式不够直接，现在的方式是NDC将增量数据写入kafka，然后下游用户消费kafka的数据topic来获取增量数据，用户直接面对的是kafka的topic，NDC的订阅任务等概念，这些无法和数据库表建立起直接的对应关系。</p>
<h4 id="2binlog">2.历史数据的追溯依赖源端数据库binlog的管理<a class="headerlink" href="#2binlog" title="Permanent link">&para;</a></h4>
<p>一旦源端数据库删除了binlog，NDC几乎没有可能获取到历史数据，虽然当前NDC一拉多推模式下会在本地磁盘缓存一部分binlog，但缓存的数据量有限（目前限制不超过10G，且停止几分钟后会删除），不适合作为一个追溯历史数据的方案。</p>
<h4 id="3">3.不能做到跨节点的一拉多推<a class="headerlink" href="#3" title="Permanent link">&para;</a></h4>
<p>NDC目前的一拉多推是通过本地磁盘的relay-log实现的，限制了下游pusher必需在工作在同一个节点，给任务的调度带来了很大限制，线上常常会因此出现资源调度的不均衡。</p>
<p>为了解决上述问题，NDC新引入的DBHub采用了如下方案：</p>
<p>1.NDC将DBHub和DBHub的一系列使用方式暴露给用户：</p>
<p>DBHub可以直接通过数据库地址从NDC平台获取到，相当于NDC平台管理的数据库的一个附件；</p>
<p>DBHub期望做到的效果是，展示给用户一个和数据库紧密联系的插件，这个插件提供多种接入方式，用户可以根据需要选择接入方式、获取不同形态的增量数据，比如flick source、Kafka topic、NDC的SDK等。</p>
<p>2.binlog写入HDFS，在一拉多推模式工作时，只有DBHub具有从源端拉取binlog的能力</p>
<p>3.pusher和puller采用tcp的方式传送增量数据，替代现在的本地磁盘的方式</p>
<h1 id="_6">整合元数据中心流表<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h1>
<h2 id="_7">一、需求<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<p>现在实时计算平台的用户想要将DDB或MySQL的某张表（或多张表）的增量数据作为source使用，一般要经过以下步骤：</p>
<ul>
<li>1.工单审批：用户通过工单提交订阅源端DDB或MySQL表的请求（人工）</li>
<li>2.创建NDC任务：工单审批通过后，用户到NDC平台创建订阅任务（半自动）</li>
<li>3.元数据中心登记：订阅任务创建成功后，用户从NDC获取对应的topic，到sloth/magina平台将topic登记为流表（人工）</li>
<li>4.开始使用</li>
</ul>
<p>当前流表的形态：</p>
<p><img alt="image-20200828160937759" src="/Users/wangtao/notes/image-20200828160937759.png" /></p>
<p>上述过程主要有两个痛点：</p>
<p>1.NDC和sloth/magina平台间没有打通，导致用户需要在多个平台进行配置，过程比较繁琐</p>
<p>2.流表的表结构没有反映出源端真实的表结构，给用户的使用造成了不便</p>
<h3 id="1-">解决痛点1&ndash;平台打通:<a class="headerlink" href="#1-" title="Permanent link">&para;</a></h3>
<p>为了打通整个过程，一种可能的方案是：</p>
<ul>
<li>1.元数据中心登记：用户到sloth或magina平台登记流表（人工），sloth或magina平台调用NDC的接口自动建立NDC任务（自动化）</li>
<li>2.开始使用</li>
</ul>
<p>这个方案将NDC任务的创建和sloth/magina平台中的流表登记融合到一个步骤中，NDC需要提供Http接口，完成订阅任务的创建，sloth/magina平台需要新增一些流表的参数，从而关联起流表和NDC的订阅任务。</p>
<p><img alt="image-20200828170627167" src="https://tinkerer-pic.oss-cn-hangzhou.aliyuncs.com/picgo/image-20200828170627167.png" /></p>
<p>另外一个方案：</p>
<p>8月27日与sloth/magina讨论后，提出了一种新的方案，sloth/magina平台不采用流表的方式展示上述表，而是直接关联到DDB/MySQL数据库表上，作为一个特殊的flink source（目前magina界面上已经有了类似功能的sink，可以仿照），用户可以直接使用，而不用关注中间的数据流转。</p>
<p>新的方案下还需要确认的问题是，调用NDC接口的时机，在流表的方案里，可以在用户登记流表的时候调用NDC的接口创建NDC订阅任务，在新的方案里，这个过程在哪个时机触发，以及是否需要用户感知还需要确认。</p>
<p>虽然产品形态上还有调整的空间，但是底层的两个基本点事不变的，一个是用户消费的仍然是kafka的topic，另一个是sloth/magina平台是调用NDC平台的接口完成这个过程。因此不管最终sloth/magina平台产品上采用哪种方案，需要NDC平台提供的接口都是一致的。</p>
<h3 id="2-">解决痛点2&ndash;新的序列化方式:<a class="headerlink" href="#2-" title="Permanent link">&para;</a></h3>
<p>需要设计一种新的序列化方式，能够在表结构中直接体现源端的表结构信息，同时还需要满足以下要求：</p>
<ul>
<li>可以解决Update前项后项的问题</li>
<li>方便用户编写SQL</li>
<li>补充额外的信息，包括消息生成时间、事件类型（INSERT DELETE UPDATR）、序列号（事务信息？）</li>
</ul>
<h2 id="ndc_1">二、方案（NDC平台）<a class="headerlink" href="#ndc_1" title="Permanent link">&para;</a></h2>
<h3 id="1-ndc">1.平台打通&ndash;NDC接口概述<a class="headerlink" href="#1-ndc" title="Permanent link">&para;</a></h3>
<p>在接口设计上，NDC提供几个概念</p>
<ul>
<li>1.DBHub：与数据库实例相对应的组件，同一个项目、同一个数据库只有一个DBHub，如da_music项目的一台DDB-10.10.10.10:8888会对应唯一的一个DBHub，查询时不管提供IP:PORT、HOST:PORT，还是jdbc连接串，都会返回同一个DBHub；DBHub用dbHubId做唯一性标识</li>
<li>2.Table（源表）：与数据库的表一一映射的概念，NDC称为数据库的源表；源表用“源表名”做唯一性标识，源表名=数据库库名.表名（DDB 4.6+的表可以省略库名）</li>
<li>3.SubTable（子表）：从属于数据库主表的表，一个源表可以有多张子表，一张子表只能属于一张源表，每一张子表描述了NDC将数据库的一张源表的数据同步到一个特定的目标端（比如kafka的一个topic），子表用“子表名”（SubTableName）做唯一性标识，从属于不同源表的子表可以重名</li>
</ul>
<p>上述三个概念是简单的从属关系，SubTable从属于Table，Table从属于DBHub。通过引入这些概念，NDC将任务的概念隐藏了起来，调用方不需要关心NDC如何组织调度任务。</p>
<p>具体到本需求，sloth/magina平台需要调用NDC的接口创建一张子表，至于SubTable的名称，sloth/magina可以预先约定采用固定的SubTableName，这样就可以做到复用（创建同名的SubTable NDC会报错），而对用户可以直接隐藏SubTableName，从用户的视角来看就是直接使用的DDB/MySQL的表。</p>
<p>除了SubTable创建、修改、删除之外，NDC还提供了DBHub/Table/SubTable三个层次的多个接口，支持DBHub查询、DBHub创建、源表查询、字段查询等功能。</p>
<p>具体接口见：</p>
<p>https://nei.hz.netease.com/project?pid=40088 DBHub分组</p>
<p><img alt="image-20200828170351063" src="/Users/wangtao/notes/image-20200828170351063.png" /> </p>
<h3 id="2">2.新的序列化方式<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<p>这部分田野补充下方案，目前的备选方案</p>
<p><strong>1.方案一：</strong></p>
<p>待解决：如何确保NDC固有的字段和数据库字段名称不重复</p>
<p><img alt="image-20200828170813077" src="/Users/wangtao/notes/image-20200828170813077.png" /></p>
<p><strong>2.方案二：magina（汪磊）从便于用户写SQL的角度提的方案</strong></p>
<p>源端的一个字段扩展为两个，如id扩展为id.old和id.new，分别对应前项和后项。</p>
<p>具体要了解下用户是怎么写sql的</p>
<h3 id="dbhub">DBHub表配置参数说明：<a class="headerlink" href="#dbhub" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>类别</th>
<th>参数</th>
<th>默认值</th>
<th>提示信息</th>
<th>是否可以修改</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>目标端</td>
<td>目标类型</td>
<td>Kafka</td>
<td>-</td>
<td>只有未启动状态可以修改</td>
<td></td>
</tr>
<tr>
<td></td>
<td>目标地址</td>
<td>ndc内部指定</td>
<td>-</td>
<td>只有未启动状态可以修改</td>
<td></td>
</tr>
<tr>
<td></td>
<td>topic</td>
<td>见topic生成规则</td>
<td>-</td>
<td>只有未启动状态可以修改</td>
<td></td>
</tr>
<tr>
<td>同步信息</td>
<td>类型</td>
<td>全选中</td>
<td>-</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td></td>
<td>过滤条件</td>
<td>空</td>
<td>输入where过滤条件</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>字段配置</td>
<td>字段</td>
<td>全选中</td>
<td>-</td>
<td>是</td>
<td></td>
</tr>
<tr>
<td>其他配置</td>
<td>kafka.partitions</td>
<td>1</td>
<td>-</td>
<td>是</td>
<td>topic partition个数</td>
</tr>
<tr>
<td></td>
<td>kafka.replication</td>
<td>2</td>
<td></td>
<td>是</td>
<td>topic 副本数</td>
</tr>
<tr>
<td></td>
<td>kafka.retention.ms</td>
<td>259200000</td>
<td></td>
<td>是</td>
<td>topic 过期时间</td>
</tr>
<tr>
<td></td>
<td>kafka.max.message.bytes</td>
<td>20000000</td>
<td></td>
<td>是</td>
<td>topic 最大消息</td>
</tr>
</tbody>
</table>
<p>注：</p>
<p>1.topic生成规则：</p>
<p>NDC-{ndc集群名称}-{ndc项目ID}-{ndc源端名称}-{库名}.{表名}.{flink}</p>
<p>如，NDC-online_v2-25-magina_test-magina.test_jww.flink</p>
<p>2.是否可以修改的补充说明：</p>
<p>任何情况下，如果存在和DBHub表关联的flink任务，且任务正在执行，则不允许修改DBHub表的任何参数。</p>
<h3 id="dbhub_1">DBHub表运行信息说明：<a class="headerlink" href="#dbhub_1" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>类别</th>
<th>参数</th>
<th>格式（单位）</th>
<th>未启动</th>
<th>运行中、暂停中、失败、恢复中、初始化、启动中、待启动、挂起</th>
<th>暂停、完成</th>
</tr>
</thead>
<tbody>
<tr>
<td>基础信息</td>
<td>表名称</td>
<td>-</td>
<td>有</td>
<td>有</td>
<td>有</td>
</tr>
<tr>
<td></td>
<td>表添加时间</td>
<td>yyyy-MM-dd HH:mm:ss</td>
<td>有</td>
<td>有</td>
<td>有</td>
</tr>
<tr>
<td></td>
<td>当前状态</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td></td>
<td>NDC任务</td>
<td>见任务命名方式</td>
<td>有</td>
<td>有</td>
<td>有</td>
</tr>
<tr>
<td>数据信息</td>
<td>最新数据时间</td>
<td>yyyy-MM-dd HH:mm:ss</td>
<td>无</td>
<td>有</td>
<td>有</td>
</tr>
<tr>
<td></td>
<td>插入</td>
<td>行</td>
<td>无</td>
<td>有</td>
<td>有</td>
</tr>
<tr>
<td></td>
<td>更新</td>
<td>行</td>
<td>无</td>
<td>有</td>
<td>有</td>
</tr>
<tr>
<td></td>
<td>删除</td>
<td>行</td>
<td>无</td>
<td>有</td>
<td>有</td>
</tr>
<tr>
<td></td>
<td>速度</td>
<td>行/s</td>
<td>无</td>
<td>有</td>
<td>无</td>
</tr>
<tr>
<td></td>
<td>流量</td>
<td>B/s</td>
<td>无</td>
<td>有</td>
<td>无</td>
</tr>
<tr>
<td></td>
<td>延迟</td>
<td>ms</td>
<td>无</td>
<td>有</td>
<td>无</td>
</tr>
<tr>
<td></td>
<td>积压</td>
<td>B</td>
<td>无</td>
<td>有</td>
<td>有</td>
</tr>
<tr>
<td>异常信息</td>
<td>失败时间</td>
<td>yyyy-MM-dd HH:mm:ss</td>
<td>无</td>
<td>可能有</td>
<td>可能有</td>
</tr>
<tr>
<td></td>
<td>错误码</td>
<td>-</td>
<td>无</td>
<td>可能有</td>
<td>可能有</td>
</tr>
<tr>
<td></td>
<td>失败原因</td>
<td>-</td>
<td>无</td>
<td>可能有</td>
<td>可能有</td>
</tr>
</tbody>
</table>
<p>注：</p>
<p>任务命名方式：</p>
<p>ROOT_{源端名称}_{源端ID}_to_{目标类型}_{目标ID}</p>
<p>如，ROOT_magina_test_44672_to_Kafka_57</p>
<h2 id="1ndc_1">1.NDC功能点概括<a class="headerlink" href="#1ndc_1" title="Permanent link">&para;</a></h2>
<ul>
<li>支持两个或多个DDB或MySQL数据库单元之间的双向同步</li>
<li>支持全量、增量数据的双向同步</li>
<li>支持自动适配表结构变更（add drop modify字段）</li>
<li>支持自动处理冲突数据（保留updateTime最大的值）</li>
<li>支持数据的实时校验，发现不一致数据</li>
<li>支持监控数据双写、数据冲突</li>
<li>支持将上述异常数据在NDC界面查看（变化趋势、异常数据内容）、发送到消息队列</li>
</ul>
<h2 id="2_1">2.数据迁移改造流程<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h2>
<h3 id="21">2.1 改造前：表结构修改<a class="headerlink" href="#21" title="Permanent link">&para;</a></h3>
<p>对于进行单元化改造的每张表，在改造之前，需要新增两个与业务无关的字段：</p>
<pre><code class="language-sql">#版本字段
alter table tableName add column `version` varchar(128) DEFAULT '0';
#时间字段
alter table tableName add column `updateTime` timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6);
</code></pre>
<p>说明：</p>
<ul>
<li>新增字段的名称（version updateTime）可以自定义，创建双向同步任务时需要为每张表指定版本字段和时间字段；</li>
<li>版本字段和时间字段不能包含在任何唯一索引中；</li>
<li>NDC之外的任何第三方不能修改这两个字段的值。</li>
</ul>
<h3 id="22">2.2 改造中：单元化改造方案<a class="headerlink" href="#22" title="Permanent link">&para;</a></h3>
<p>单元化改造需要将一个数据库拆分为多个数据库单元，多个数据库单元的数据是一致的，ndc提供了两种方案来完成这个过程：</p>
<h4 id="ndc_2"><strong>方案一：NDC进行全量同步+增量同步</strong>（推荐）<a class="headerlink" href="#ndc_2" title="Permanent link">&para;</a></h4>
<p>NDC会进行全量同步，并在全量同步完成后自动进行增量同步</p>
<p>以拆分为两个数据库单元为例：</p>
<ul>
<li>
<p>先创建两个表结构完全一致的数据库单元，一个单元包含了完整数据，另一个单元没有数据；</p>
</li>
<li>
<p>创建这两个数据库单元的双向同步任务，选择全量同步、增量同步</p>
</li>
<li>启动任务后，NDC会自动记录增量位置点，然后先进行一次全量数据同步，将两个单元的全量数据分别写入另一个库，采用的是INSERT IGNORE的方式</li>
<li>全量完成后，会进行增量同步，增量同步的位置点即全量开始前记录的位置点</li>
</ul>
<h4 id="ndc_3"><strong>方案二：NDC只负责增量同步</strong><a class="headerlink" href="#ndc_3" title="Permanent link">&para;</a></h4>
<ul>
<li>业务采用其他方案先将全量数据同步到所有数据库单元</li>
<li>创建NDC双向同步任务，只开启增量同步</li>
<li>为增量同步到每个子任务指定binlog位置点</li>
<li>启动任务</li>
</ul>
<h3 id="23">2.3 改造后：数据校验<a class="headerlink" href="#23" title="Permanent link">&para;</a></h3>
<p>ndc提供数据校验的功能，在单元化改造完成全量同步、进行增量同步、业务改造之前，先进行全量数据一致性校验：</p>
<ul>
<li>
<p>推荐创建正向、反向两个数据校验任务（单向的校验任务无法发现目标端多数据），分别进行100%的数据校验。</p>
</li>
<li>
<p>配置校验任务需要将上述与业务无关的版本字段排除在校验范围内（时间字段可以参与校验）</p>
</li>
</ul>
<h2 id="3_1">3.表结构变更<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h2>
<p>NDC的双向同步不进行DDL的同步，需要数据库运维方在双向同步的各个单元都执行DDL，NDC任务会自动适配表结构的变更。在这个过程中，各个单元执行DDL的时间不是严格一致的，NDC在保证数据最终一致性不被破坏的情况下，尽可能，需要特定的运维方案：</p>
<h3 id="31">3.1 新增字段（支持）<a class="headerlink" href="#31" title="Permanent link">&para;</a></h3>
<p>新增字段的操作顺序：在所有单元新增字段后，修改NDC双向同步任务，将新增的字段添加到同步范围内，之后开放字段给业务使用。</p>
<p>对于上述过程，NDC暴露了一些自动化接口，可以与工单系统进行配合，在通过工单执行整个表结构变更时（在所有单元新增字段），调用NDC接口，告知NDC进行表结构的变更的数据库和DDL，NDC会自动完成双向同步任务的修改（需要自动化的适配的任务，要开启“同步全部字段”选项）。</p>
<h3 id="32">3.2 删除字段（支持）<a class="headerlink" href="#32" title="Permanent link">&para;</a></h3>
<p>删除字段与新增字段相似，但操作顺序相反：需要业务先释放不再使用的字段，然后修改NDC任务删除对应字段，然后在所有单元删除字段即可。</p>
<h3 id="33">3.3 修改字段类型（支持）<a class="headerlink" href="#33" title="Permanent link">&para;</a></h3>
<p>只要修改前后的字段类型可以兼容，不需要告知NDC，直接在各个单元修改即可；
如果修改前后的字段类型不兼容，会造成NDC任务失败，需要等所有单元修改完成后，再恢复任务（实际不应当出现这样的场景）</p>
<h3 id="34">3.4 修改字段名（不支持）<a class="headerlink" href="#34" title="Permanent link">&para;</a></h3>
<p>目前版本不支持修改字段名称，修改字段名称会造成任务失败，需要等所有单元修改完成后，再恢复任务</p>
<h3 id="35">3.5 修改字段顺序<a class="headerlink" href="#35" title="Permanent link">&para;</a></h3>
<p>NDC支持修改字段顺序，即使源和目标的字段顺序不一致，NDC也可以进行数据同步</p>
<h3 id="36">3.6 增删索引<a class="headerlink" href="#36" title="Permanent link">&para;</a></h3>
<p>增加删除索引不影响NDC的同步，但是唯一性索引的增删存在风险，可能会造成数据不一致，主要是因为索引生效的时机在每个单元是不同的，这期间可能发生数据的聚合（NDC的实时校验可以发现这样的数据不一致）</p>
<h2 id="4ddb">4.DDB扩容缩容<a class="headerlink" href="#4ddb" title="Permanent link">&para;</a></h2>
<p>目前NDC对普通的同步、订阅任务可以做到自动适配DDB的扩容、缩容，并保证数据一致，对于双向同步任务，这个特性仍然支持，而且双向同步任务支持对每个单元独立进行扩容、缩容等操作。</p>
<p>对单元化的DDB数据库进行扩容、缩容时，对每一个单元依次进行扩容即可（或者只对部分单元扩容也是可以接受的）：先扩容一个单元的DDB，确认NDC任务已经适配，再扩容另外一个单元的DDB，确认NDC任务已经适配&hellip;整个过程完成后，NDC可以保证数据的一致性；在扩容期间，NDC会进行一些任务的位置点回退，可能会产生短暂的数据延迟，理论上这个过程会在1分钟内完成。</p>
<p>如果只是对某些表进行策略切换，NDC也可以适配，在每个单元依次进行策略切换即可。</p>
<h2 id="5">5.故障处理<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<h3 id="51">5.1 数据库主从切换<a class="headerlink" href="#51" title="Permanent link">&para;</a></h3>
<p>数据库宕机引发主从切换或者运维过程中主动进行主从切换，NDC的处理方案和DDB扩容、缩容是相同的，只要DDB进行了主从切换，NDC任务也会进行自动适配，位置点会保持与之前的主库一致，因此几乎不会产生延迟，这个过程正常情况下也会在1分钟内完成。</p>
<h3 id="52">5.2 其他待补充<a class="headerlink" href="#52" title="Permanent link">&para;</a></h3>
<h2 id="6">6.异常数据处理<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<p>ndc将异常数据分为了三类：</p>
<ul>
<li>
<p><strong>数据双写</strong>是指数据库单元化场景下，用户在多个数据库对一行记录进行了变更。（对应与用户约定的数据双写，由冲突检测发现）</p>
</li>
<li>
<p><strong>数据冲突</strong>是指在数据库单元化场景下，一行记录发生了数据双写，且在某一个版本的基础上产生了有分歧的变更（破坏了版本链）。（对应与用户约定的已解决冲突，由冲突检测发现）</p>
</li>
<li>
<p><strong>未解决冲突</strong>是指数据库单元化场景下，数据出现最终不一致。（对应与用户约定的未解决冲突，由实时校验发现）</p>
</li>
</ul>
<p>NDC可以监测这三类异常数据，支持：</p>
<ul>
<li>在NDC界面查看这三类异常数据的变化趋势</li>
<li>在异常数据增加时报警（每一类异常可独立配置）</li>
<li>将异常数据写入消息队列（每一类异常可独立配置topic）</li>
<li>在NDC界面中查看已经发送的异常数据的内容</li>
</ul>
<p>version字段内容有三个部分</p>
<p>offset;ID1:seqno1,ID2:seqno2,ID3:seqno3;ext</p>
<p>其中</p>
<p>offset为版本号，表示本库的这行数据总共被NDC更新了多少次（用于规避回环复制），每次NDC更新数据时，offset+1</p>
<p>ID1～3为数据库唯一ID，包含任务唯一标识-父实例标识-mysql标识；</p>
<p>seqno1～3为序列号，是任务级别的，对某一行数据来说，seqno是不连续的，用于识别双写切换</p>
<p>ext为额外的参数，现在有LB FLB</p>
<p>缩短version字段长度的思路：
1.缩短offset：执行sql时加入mod()函数，offset形成有限位数的循环变更
如最高两位，mod(CAST(SUBSTRING_INDEX(name, &lsquo;;&rsquo; ,1) as UNSIGNED) + 1,100)
2.缩短ID：分配唯一ID，采用Base 64或Base 62方案编码和解码，缩短长度
3.缩短seqno：有限位数循环，代码中实现即可</p>
<p><strong>位数设计</strong>：目标-保证三个(n=3)机房下varchar(32)可以满足要求：
offset 3位
ID 4位
seqno 2位
ext 3位</p>
<p>总共 = offset + (ID + seqno + 2)n + 1 + ext
n = 3 时
3 +  (4 + 2 + 2)3 + 1 + 3 = 31 &lt; 32
n = 2 时
3 +  (4 + 2 + 2)*2 + 1 + 3 = 23</p>
<p>因此两个机房时，varchar(24)可以满足要求</p>
<h2 id="_8">性能分析功能<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<p>新加功能：性能分析功能</p>
<p>入口在子任务（puller）运行信息的每个状态栏标题内</p>
<ul>
<li>启动性能分析</li>
</ul>
<p>默认不会开启，可以在任务（puller）运行中开启，必需手动触发开启，开启时需要指定开启的时长，避免长时间开启忘记关闭；</p>
<ul>
<li>关闭性能分析</li>
</ul>
<p>性能分析开启后，会增加统计功能，并打印statistic日志，前端”运行信息“的“全量同步”“增量同步”“增量推送”标签栏中会增加”性能分析链接“，点击后可以查看性能相关的运行参数，并提供刷新功能</p>
<p>性能相关的运行参数包含三种：</p>
<ul>
<li>配置参数：任务隐含的一些配置，不会随时间变化</li>
<li>瞬时参数：可以在某一确定时刻获取的参数，如活跃线程数</li>
<li>统计参数：需要在一段时间里统计得到的参数（默认20s），比如速度</li>
</ul>
<h2 id="_9">监控参数<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<h3 id="puller">Puller监控参数<a class="headerlink" href="#puller" title="Permanent link">&para;</a></h3>
<pre><code class="language-java">// 已缓存的relayLog大小 B
private long totalRelayLogByte;
// binlog dump速度 B/s
private long dumpFlowRate;
// 源端binlog生成速度 B/s
private long binlogGrowthRate;
// 日志积压大小 B
private long leftRelayLogByte;
// 网络占比：等待MySQL发送binlog的时间所占百分比
private float waitingBinlogRatio;
// 磁盘占比：等待写relayLog的时间所占百分比
private float waitingWriteRelayLogRatio;
</code></pre>
<table>
<thead>
<tr>
<th>场景</th>
<th>延迟</th>
<th>日志积压大小</th>
<th>源端binlog生成速度</th>
<th>binlog dump速度</th>
<th>已缓存的relayLog大小</th>
<th>网络占比</th>
<th>磁盘占比</th>
</tr>
</thead>
<tbody>
<tr>
<td>MySQL主从延迟</td>
<td>高</td>
<td>低</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>MySQL节点或者Puller节点网卡打爆了</td>
<td>高</td>
<td>高</td>
<td>可能高</td>
<td>低</td>
<td>-</td>
<td>高</td>
<td>低</td>
</tr>
<tr>
<td>Puller节点磁盘IO满了</td>
<td>高</td>
<td>高</td>
<td>可能高</td>
<td>低</td>
<td>-</td>
<td>低</td>
<td>高</td>
</tr>
<tr>
<td>Puller节点接收binlog存储磁盘达到了瓶颈</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>高</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>Pusher节点消费成为瓶颈，Puller日志缓存达到上限</td>
<td>低</td>
<td>低</td>
<td>-</td>
<td>-</td>
<td>高，结合任务状态定位</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>正常，正在追积压数据</td>
<td>高</td>
<td>高</td>
<td>正常</td>
<td>高</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>正常，源端没有binlog生成</td>
<td>低</td>
<td>低</td>
<td>低</td>
<td>低</td>
<td>正常</td>
<td>高</td>
<td>低</td>
</tr>
</tbody>
</table>
<p>磁盘占比和网络占比两个参数可能带来性能损耗，建议放在性能分析中实现，其他参数可以常态化采集</p>
<h3 id="_10">任务监控参数<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>阶段</th>
<th>细分类别</th>
<th>层级</th>
<th>参数（单位）</th>
<th>常态化</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>全量同步</td>
<td>整体</td>
<td>最外层（运行信息）</td>
<td>同步速度（行/s）</td>
<td>是</td>
<td>统计参数</td>
</tr>
<tr>
<td></td>
<td>整体</td>
<td>最外层（运行信息）</td>
<td>解决冲突数据（行/s）</td>
<td>是</td>
<td>统计参数</td>
</tr>
<tr>
<td></td>
<td>整体</td>
<td>表级别（列表）</td>
<td>冲突数据（行）</td>
<td>是</td>
<td>瞬时值</td>
</tr>
<tr>
<td></td>
<td>拉取</td>
<td>性能分析层</td>
<td>瞬时速度（行/s）</td>
<td>是</td>
<td>统计参数</td>
</tr>
<tr>
<td></td>
<td></td>
<td>- 展开</td>
<td>sql平均耗时（ns）</td>
<td>是</td>
<td>统计参数</td>
</tr>
<tr>
<td></td>
<td></td>
<td>- 展开</td>
<td>活跃线程数（活跃数/总数）</td>
<td>是</td>
<td>瞬时值</td>
</tr>
<tr>
<td></td>
<td>缓存</td>
<td>性能分析层</td>
<td>缓存使用量（%）</td>
<td>是</td>
<td>瞬时值</td>
</tr>
<tr>
<td></td>
<td>插入</td>
<td>性能分析层</td>
<td>瞬时速度（行/s）</td>
<td>是</td>
<td>统计参数</td>
</tr>
<tr>
<td></td>
<td></td>
<td>- 展开</td>
<td>sql平均耗时（ns）</td>
<td>是</td>
<td>统计参数</td>
</tr>
<tr>
<td></td>
<td></td>
<td>- 展开</td>
<td>活跃线程数（活跃数/总数）</td>
<td>是</td>
<td>瞬时值</td>
</tr>
<tr>
<td></td>
<td></td>
<td>- 展开</td>
<td>batch大小</td>
<td>是</td>
<td>固定配置值</td>
</tr>
<tr>
<td>增量同步</td>
<td>整体</td>
<td>最外层（运行信息）</td>
<td>同步速度（行/s）</td>
<td>是</td>
<td>统计参数</td>
</tr>
<tr>
<td></td>
<td>整体</td>
<td>最外层（运行信息）</td>
<td>延迟（ms）</td>
<td>是</td>
<td>瞬时值</td>
</tr>
<tr>
<td></td>
<td>整体</td>
<td>最外层（运行信息）</td>
<td>积压（B）</td>
<td>是</td>
<td>瞬时值</td>
</tr>
<tr>
<td></td>
<td>拉取</td>
<td>性能分析层</td>
<td>瞬时速度（行/s）</td>
<td>-</td>
<td>统计参数</td>
</tr>
<tr>
<td></td>
<td></td>
<td>- 展开</td>
<td>解析速度（行/s）</td>
<td>-</td>
<td>统计参数</td>
</tr>
<tr>
<td></td>
<td>转化</td>
<td>性能分析层</td>
<td>瞬时速度（行/s）待定</td>
<td>-</td>
<td>统计参数</td>
</tr>
<tr>
<td></td>
<td>缓存</td>
<td>性能分析层</td>
<td>缓存使用量（%）</td>
<td>是</td>
<td>瞬时值</td>
</tr>
<tr>
<td></td>
<td></td>
<td>- 展开</td>
<td>缓存容量</td>
<td>是</td>
<td>瞬时值</td>
</tr>
<tr>
<td></td>
<td></td>
<td>- 展开</td>
<td>最长队列大小</td>
<td>是</td>
<td>瞬时值</td>
</tr>
<tr>
<td></td>
<td></td>
<td>- 展开</td>
<td>最长队列索引值</td>
<td>是</td>
<td>瞬时值</td>
</tr>
<tr>
<td></td>
<td></td>
<td>- 展开</td>
<td>可执行队列大小</td>
<td>是</td>
<td>瞬时值</td>
</tr>
<tr>
<td></td>
<td>插入</td>
<td>性能分析层</td>
<td>瞬时速度（行/s）</td>
<td>-</td>
<td>统计参数</td>
</tr>
<tr>
<td></td>
<td></td>
<td>- 展开</td>
<td>sql平均耗时（ns）</td>
<td>-</td>
<td>统计参数</td>
</tr>
<tr>
<td></td>
<td></td>
<td>- 展开</td>
<td>活跃线程数（活跃数/总数）</td>
<td>是</td>
<td>瞬时值</td>
</tr>
<tr>
<td></td>
<td></td>
<td>- 展开</td>
<td>batch大小</td>
<td>-</td>
<td>统计参数</td>
</tr>
<tr>
<td>订阅推送</td>
<td>整体</td>
<td>最外层（运行信息）</td>
<td>推送速度 行/s</td>
<td>是</td>
<td>统计参数</td>
</tr>
<tr>
<td></td>
<td>整体</td>
<td>最外层（运行信息）</td>
<td>延迟（ms）</td>
<td>是</td>
<td>瞬时值</td>
</tr>
<tr>
<td></td>
<td>整体</td>
<td>最外层（运行信息）</td>
<td>积压（B）</td>
<td>是</td>
<td>瞬时值</td>
</tr>
<tr>
<td></td>
<td>拉取</td>
<td>性能分析层</td>
<td>瞬时速度（行/s）</td>
<td>-</td>
<td>统计参数</td>
</tr>
<tr>
<td></td>
<td></td>
<td>- 展开</td>
<td>解析速度（行/s）</td>
<td>-</td>
<td>统计参数</td>
</tr>
<tr>
<td></td>
<td>转化</td>
<td>性能分析层</td>
<td>瞬时速度（行/s）待定</td>
<td>-</td>
<td>统计参数</td>
</tr>
<tr>
<td></td>
<td>推送</td>
<td>性能分析层</td>
<td>瞬时速度（行/s）</td>
<td>-</td>
<td>统计参数</td>
</tr>
<tr>
<td></td>
<td></td>
<td>- 展开</td>
<td>消息推送平均耗时（ns）</td>
<td>-</td>
<td>统计参数</td>
</tr>
<tr>
<td></td>
<td></td>
<td>- 展开</td>
<td>消息平均大小（行）</td>
<td>-</td>
<td>统计参数</td>
</tr>
</tbody>
</table>
<p>会保证同步速度、瞬时速度、解析速度之间具有可比性</p>
<p>场景分析</p>
<p>全量：</p>
<table>
<thead>
<tr>
<th></th>
<th>整体</th>
<th></th>
<th>拉取</th>
<th></th>
<th></th>
<th>缓存</th>
<th>插入</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>场景</strong></td>
<td>同步速度</td>
<td>解决冲突数据</td>
<td>瞬时速度</td>
<td>sql平均耗时</td>
<td>活跃线程数</td>
<td>缓存使用量</td>
<td>瞬时速度</td>
<td>sql平均耗时</td>
<td>活跃线程数</td>
</tr>
<tr>
<td>慢查询导致同步慢</td>
<td>低</td>
<td>极少</td>
<td>低</td>
<td><strong>极长</strong></td>
<td>正常</td>
<td><strong>低</strong></td>
<td>高/正常</td>
<td>短/正常</td>
<td>正常</td>
</tr>
<tr>
<td>拉取并发太低导致同步慢</td>
<td>低</td>
<td>极少</td>
<td>低</td>
<td><strong>长/正常</strong></td>
<td><strong>低</strong></td>
<td><strong>低</strong></td>
<td>高/正常</td>
<td>短/正常</td>
<td>正常</td>
</tr>
<tr>
<td>写入并发太低导致同步慢</td>
<td>低</td>
<td>极少</td>
<td>高/正常</td>
<td>短/正常</td>
<td>正常</td>
<td><strong>高</strong></td>
<td>低</td>
<td>正常</td>
<td><strong>低</strong></td>
</tr>
<tr>
<td>写入网络延迟高导致同步慢</td>
<td>低</td>
<td>极少</td>
<td>高/正常</td>
<td>短/正常</td>
<td>正常</td>
<td><strong>高</strong></td>
<td>低</td>
<td><strong>长，但和网络延迟同一量级</strong></td>
<td>正常</td>
</tr>
<tr>
<td>目标端到达写入瓶颈[注1]</td>
<td>低</td>
<td>极少</td>
<td>高/正常</td>
<td>短/正常</td>
<td>正常</td>
<td><strong>高</strong></td>
<td>低</td>
<td><strong>长，显著高于网络延迟</strong></td>
<td><strong>高</strong></td>
</tr>
<tr>
<td>大量解决冲突造成同步慢</td>
<td>低</td>
<td><strong>和同步速度相仿</strong></td>
<td>高/正常</td>
<td>短/正常</td>
<td>正常</td>
<td><strong>高</strong></td>
<td>低</td>
<td>短/正常</td>
<td>正常</td>
</tr>
</tbody>
</table>
<p>[注1]：区分目标端到达写入瓶颈和网络通信延迟的场景：</p>
<p>提高写入并发后（活跃线程数）：</p>
<p>如果目标端到达瓶颈，则插入瞬时速度基本不变，sql平均耗时增大；</p>
<p>如果网络通信延迟，则插入速度增大，sql平均耗时基本不变（和通信延迟在同一量级）；</p>
<p>增量：</p>
<table>
<thead>
<tr>
<th></th>
<th>整体</th>
<th></th>
<th></th>
<th>拉取</th>
<th></th>
<th>缓存</th>
<th></th>
<th></th>
<th>插入</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>场景</strong></td>
<td>同步速度</td>
<td>延迟</td>
<td>积压</td>
<td>瞬时速度</td>
<td>解析速度</td>
<td>缓存使用量</td>
<td>最长队列</td>
<td>可执行队列</td>
<td>瞬时速度</td>
<td>sql平均耗时</td>
<td>活跃线程数</td>
</tr>
<tr>
<td>解析成为瓶颈</td>
<td>低</td>
<td>高</td>
<td>高</td>
<td>低</td>
<td><strong>低</strong></td>
<td><strong>低</strong></td>
<td>低</td>
<td>低</td>
<td>高</td>
<td>短</td>
<td>正常</td>
</tr>
<tr>
<td>transfer有异常耗时操作</td>
<td>低</td>
<td>高</td>
<td>高</td>
<td><strong>高</strong></td>
<td>高</td>
<td>低</td>
<td>低</td>
<td>低</td>
<td><strong>高</strong></td>
<td>短</td>
<td>正常</td>
</tr>
<tr>
<td>插入sql执行慢成为瓶颈</td>
<td>低</td>
<td>高</td>
<td>高</td>
<td>高</td>
<td>高</td>
<td><strong>高</strong></td>
<td>低</td>
<td><strong>高</strong></td>
<td>低</td>
<td><strong>长</strong></td>
<td>正常</td>
</tr>
<tr>
<td>插入并发不够</td>
<td>低</td>
<td>高</td>
<td>高</td>
<td>高</td>
<td>高</td>
<td><strong>高</strong></td>
<td>低</td>
<td><strong>高</strong></td>
<td>低</td>
<td>短</td>
<td><strong>低</strong></td>
</tr>
<tr>
<td>单行数据频繁更新</td>
<td>低</td>
<td>高</td>
<td>高</td>
<td>高</td>
<td>高</td>
<td>高</td>
<td><strong>高</strong></td>
<td><strong>低</strong></td>
<td>高</td>
<td>短</td>
<td>低</td>
</tr>
<tr>
<td>拉取binlog网络成为瓶颈，有binlog积压</td>
<td>低</td>
<td>高</td>
<td>高</td>
<td><strong>低</strong></td>
<td><strong>高</strong></td>
<td><strong>低</strong></td>
<td>低</td>
<td>低</td>
<td>高</td>
<td>短</td>
<td>低</td>
</tr>
<tr>
<td>主从复制存在延迟</td>
<td>正常</td>
<td>高</td>
<td><strong>低</strong></td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>正常：源端binlog积压，解析快</td>
<td>高</td>
<td>低</td>
<td>低</td>
<td>高</td>
<td>高</td>
<td>高</td>
<td>低</td>
<td>高</td>
<td>高</td>
<td>短</td>
<td>正常</td>
</tr>
<tr>
<td>正常：源端产生少量增量数据，无binlog积压</td>
<td>低</td>
<td>低</td>
<td>低</td>
<td>低</td>
<td>高</td>
<td>低</td>
<td>低</td>
<td>低</td>
<td>高</td>
<td>短</td>
<td>低</td>
</tr>
<tr>
<td>正常：大量数据被过滤掉</td>
<td>低</td>
<td>低</td>
<td>低</td>
<td>高</td>
<td>高</td>
<td>低</td>
<td>低</td>
<td>低</td>
<td>高</td>
<td>短</td>
<td>低</td>
</tr>
</tbody>
</table>
<p>订阅：</p>
<table>
<thead>
<tr>
<th></th>
<th>整体</th>
<th>拉取</th>
<th></th>
<th>推送</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>场景</strong></td>
<td>推送速度</td>
<td>瞬时速度</td>
<td>解析速度</td>
<td>瞬时速度</td>
<td>消息推送平均耗时</td>
</tr>
<tr>
<td>解析速度成为瓶颈</td>
<td>低</td>
<td>低</td>
<td>低</td>
<td>高</td>
<td>短</td>
</tr>
<tr>
<td>transfer有异常耗时操作</td>
<td>低</td>
<td>高</td>
<td>高</td>
<td>高</td>
<td>短</td>
</tr>
<tr>
<td>推送成为瓶颈</td>
<td>低</td>
<td>高</td>
<td>高</td>
<td>低</td>
<td>长</td>
</tr>
</tbody>
</table>
<h3 id="_11">全量同步<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p><strong>select&ndash;&gt;cache&ndash;&gt;insert</strong></p>
<ul>
<li>已有参数：全量执行速度 行/s</li>
<li>select 平均执行时间 ns：确认是否有慢查询，帮助确认batch设置是否合理</li>
<li>select 速度上限 行/s：不考虑等待insert引起的损失，确认调整select参数的效果</li>
<li>insert 平均执行时间 ns：确认insert的执行是否存在瓶颈</li>
<li>insert 速度上限 行/s：不考虑等待select引起的损失，确认调整insert参数的效果</li>
<li>select 活跃线程数：真正使用的线程数（已有拉取并发作为配置的值）</li>
<li>insert 活跃线程数：真正使用的线程数（已有插入并发数作为配置的值）</li>
<li>select 线程空闲率 %：在使用的线程有多少时间用于等待写入缓存队列*</li>
<li>insert 线程空闲率 %：在使用的线程有多少时间用于等待从缓存队列中获取数据*</li>
<li>冲突数据处理 行/s：全量速度比较慢时，确认是否时因为目标端存在大量冲突数据</li>
<li>累计冲突数据：行（表级别），作用同上</li>
</ul>
<h3 id="_12">增量同步<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p><strong>extract&ndash;&gt;transfer&ndash;&gt;cache(eventGraph)&ndash;&gt;applyWorker</strong></p>
<ul>
<li>已有参数：同步速度 行/s</li>
<li>解析速度上限 行/s：确认解析是否是瓶颈</li>
<li>解析性能余量 %：100% - 解析时间占extract总处理时间的比例</li>
<li>系统性能余量 %：等待MySQL发送binlog的时间占整个extract处理时间的比例</li>
<li>apply 活跃线程数：真正使用的线程数，确认增大并发是否有作用，以及发现挂掉的线程？</li>
<li>apply 速度上限 行/s：确认瓶颈是否在apply，确认调整apply参数的效果（所有apply线程之和）</li>
<li>事务平均大小 行：确认批量行级的效果</li>
<li>apply 平均事务执行时间 ns：</li>
<li>apply 线程空闲率 %：在使用的线程有多少时间用于等待eventGraph</li>
<li>缓存容量：eventGraph可以容纳的event个数</li>
<li>缓存用量 %：eventGraph的event个数与上限的比例</li>
<li>待执行event个数：eventGraph的slaveQueue中的event个数，帮助确认瓶颈在apply</li>
<li>冲突数据比例 %：100% - eventGraph中indepenent event占的比例</li>
</ul>
<h3 id="_13">订阅（增量推送）<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p><strong>extract&ndash;&gt;tranfer&ndash;&gt;apply</strong></p>
<ul>
<li>消息推送速度 行/s</li>
<li>解析速度上限 行/s：确认解析是否是瓶颈</li>
<li>解析性能余量 %：100% - 解析时间占extract总处理时间的比例</li>
<li>系统性能余量 %：等待MySQL发送binlog的时间占整个extract处理时间的比例</li>
<li>推送消息平均时间 ns：写入单个消息花费的平均时间</li>
<li>推送消息速度上限 event/s：写入消息队列的理论速度上限</li>
</ul>
<p>常态化采集</p>
<table>
<thead>
<tr>
<th>场景</th>
<th></th>
<th></th>
<th></th>
<th>结果</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>序号</td>
<td>是否配置了报警</td>
<td>是否配置了延迟和积压</td>
<td>是否配置了报警人</td>
<td>任务报警人</td>
<td>平台管理员</td>
</tr>
<tr>
<td>1</td>
<td>是</td>
<td>是</td>
<td>是</td>
<td>任务阈值报警</td>
<td>平台阈值和任务阈值的较大值报警</td>
</tr>
<tr>
<td>2</td>
<td>是</td>
<td>是</td>
<td>否</td>
<td>不报警</td>
<td>任务报警</td>
</tr>
<tr>
<td>3</td>
<td>是</td>
<td>否</td>
<td>是/否</td>
<td>不报警</td>
<td>不报警</td>
</tr>
<tr>
<td>4</td>
<td>否</td>
<td>-</td>
<td>-</td>
<td>不报警</td>
<td>平台阈值报警</td>
</tr>
</tbody>
</table>
<p>蒋文伟的核实推广问题，周四上线功能，直接走NDC的接口获取源端</p>
<p>处理https链接跳转问题，nginx申请新增配置，ndp申请新增tomcat模版，已部署</p>
<p>3.1.0 hot-fix，处理druid解析DDL的问题，升级druid到最新版本，解决兼容性问题，小版本3.1.0.2，发布到ndctest环境</p>
<p>新开3.2.0版本，合并了最近修改的develop分支</p>
<p>数据订阅</p>
<p>功能点</p>
<ul>
<li>
<p>将数据库增量变更写入消息队列；</p>
</li>
<li>
<p>支持MySQL DDB Oracle DB2作为数据源，支持一拉多推功能，多任务共享拉取源端日志；</p>
</li>
<li>
<p>支持消息写入Kafka Nydus(RocketMQ)，支持topic的自动创建和管理；</p>
</li>
<li>
<p>支持配置消息粒度：单行消息、事务消息，可配置消息大小；</p>
</li>
<li>
<p>支持每张表自定义分区字段；</p>
</li>
<li>
<p>支持数据过滤过滤：变更类型过滤（insert delete update）、字段过滤、行过滤（配置sql语句）；</p>
</li>
<li>
<p>支持结构同步：自动适配源端表结构变更（加列、删列、修改列）；</p>
</li>
<li>
<p>支持不同的消息格式：NDC自定义格式、canal_json格式；</p>
</li>
<li>
<p>提供消费端SDK，可配置顺序或并发消费；</p>
</li>
</ul>
<p>运维</p>
<ul>
<li>
<p>支持任务模型，任务包含多张表同步到多个topic，任务之间进程资源隔离；</p>
</li>
<li>
<p>支持任务的创建、启动、停止、删除等基本操作；</p>
</li>
<li>
<p>支持断点续传，任务启停、高可用等场景下，保证消息的at least once；</p>
</li>
<li>
<p>支持回放数据库历史增量数据，可按照时间回放数据；</p>
</li>
<li>
<p>支持界面上查看任务运行状态，消息推送速度，日志积压，延迟等实时信息，支持查看上述信息的历史变化图表；</p>
</li>
<li>
<p>支持查看SDK消费端消息积压，消费延迟等状态；</p>
</li>
<li>
<p>支持权限管理，区分任务的查看和操作权限，支持为每个任务配置任务管理员；</p>
</li>
<li>
<p>支持任务状态、延迟、积压的监控和报警，可配置多种报警方式和报警升级策略，支持接入猛犸报警系统；</p>
</li>
<li>
<p>用户可查看对任务的操作历史；</p>
</li>
<li>
<p>自动适配源端DDB实例切换、表策略切换等操作；</p>
</li>
</ul>
<h2 id="20213">数据库单元化成果和后续落地规划（2021年3月）：<a class="headerlink" href="#20213" title="Permanent link">&para;</a></h2>
<h3 id="_14">概述<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<p>数据库单元化是业务单元化改造中的最基础最核心的环节，NDC依托于自研的数据库的双向同步功能，构建了数据库的单元化的完整方案，支撑了音乐业务进行单元化改造。</p>
<p>在功能演进过程中，NDC形成了两套单元化改造方案，分别适用于不同的业务场景，两套方案均已在音乐落地。</p>
<h4 id="gtid">方案一：基于GTID的数据库单元化方案<a class="headerlink" href="#gtid" title="Permanent link">&para;</a></h4>
<p><strong>方案特点</strong></p>
<p>核心特点是对业务表结构没有侵入，业务表可以直接接入，改造成本低，利用MySQL数据库内部的GTID机制解决了双向同步中的回环复制问题，性能损耗低（不超过10%）。</p>
<p><strong>方案应用</strong></p>
<p>该方案在音乐推荐业务中落地，在推荐业务两个DDB数据库单元之间进行数据双向同步，支持业务完成写入流量切换、读写分离等功能，每组线上MySQL实例稳定提供接近1万行/s的同步速度，平均同步延迟不超过1s。</p>
<p><img alt="image-20210302213005956" src="https://tinkerer-pic.oss-cn-hangzhou.aliyuncs.com/picgo/image-20210302213005956.png" /></p>
<p><strong>不足</strong></p>
<p>该方案的不足主要在于：</p>
<ul>
<li>不能处理数据冲突：如果一行数据在多个机房并发更新，可能造成数据不一致</li>
<li>只支持MySQL/DDB之间的数据同步</li>
</ul>
<h4 id="_15">方案二：基于隐藏字段的数据库单元化方案<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h4>
<p><strong>方案特点</strong></p>
<p>基于隐藏字段的方案更具通用型，可以适配更多的同构/异构的关系型数据的单元化改造，同时支持数据双写场景，具有自动处理冲突数据的功能，保证数据最终一致性，弥补了上述GTID方案的不足；该方案从应用的单元化改造需求出发，提供了数据双写监测、数据冲突发现、实时数据校验等实用功能；另外对于数据库常见的运维场景，支持在不中断数据同步的情况下完成表结构变更，也支持自动适配DDB的扩容、切换等需求；在NDC的部署方式上，也实现了跨机房的集群部署，集群内部尽可能减少跨机房的通信。</p>
<p><strong>方案应用</strong></p>
<p>由于该方案具有很高的功能完整性，已经成为音乐单元化改造中数据库单元化的落地方案，已经协助音乐完成了两个业务的（举报系统、我的大学应用）单元化改造，目前已经在建德、杭州两个机房的稳定运行数月，在业务的流量切换、数据双写等场景下，冲突解决、冲突发现、实时校验等功能也在线上环境得到了验证。</p>
<p><img alt="image-20210302222247996" src="https://tinkerer-pic.oss-cn-hangzhou.aliyuncs.com/picgo/image-20210302222247996.png" /></p>
<p><strong>不足</strong></p>
<p>该方案的不足主要在于：业务表需要新增隐藏字段，有一定的改造代价。</p>
<h3 id="_16">后续计划<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<h4 id="1">1.推广计划<a class="headerlink" href="#1" title="Permanent link">&para;</a></h4>
<p>2021年音乐单元化改造计划表</p>
<p>Q1：用户读、music-user-setting业务单元化改造落地</p>
<p>Q2：曲库读/privilege、歌单单元化落地</p>
<p>Q3：业务自助单元化</p>
<p>德邦单元化需求？</p>
<p><img src="https://tinkerer-pic.oss-cn-hangzhou.aliyuncs.com/picgo/image-20210302195233801.png" alt="image-20210302195233801" style="zoom: 50%;" /></p>
<h4 id="2_2">2.功能规划<a class="headerlink" href="#2_2" title="Permanent link">&para;</a></h4>
<ul>
<li>机房通信延迟较高的场景下，QPS提升：跨机房执行SQL优化为跨机房传输日志（支持三单元部署）</li>
<li>完善表结构变更支持</li>
<li>自动适配DDB实例切换</li>
<li>完善任务故障恢复流程</li>
</ul>
<p>major compaction时机：delete文件多</p>
<p>minor-compaction分为两类，一类是delete files的compaction，一类是insert files的compaction，两种合并互不影响。</p>
<p>delete files的compaction只处理delete files，输出的结果是合并之后的delete files文件，commit提交的效果是合并之后的delete files代替合并之前的delete files；</p>
<p>insert files的compaction处理insert files和delete files，输出的结果是合并之后的insert files文件，delete files文件合并前后不受影响，commit提交的结果是合并之后的insert files代替合并之前的insert files。</p>
<p>这样拆分的出发点在于insert files与delete files的合并会产生两个输出，一个是insert file，一个是delete file，一起处理会带来比较高的复杂性，比如不容易根据输出文件的大小确定Task拆分。</p>
<p><img alt="image-20210305003336940" src="/Users/wangtao/notes/image-20210305003336940.png" /></p>
<p>delete files compaction</p>
<p><img alt="image-20210305003402161" src="/Users/wangtao/notes/image-20210305003402161.png" /></p>
<p>Insert files compaction</p>
<p>NDC平台核心开发，参与NDC的功能设计、评审、开发、测试，以及NDC平台日常运维</p>
<p>NDC主要功能的设计、评审、开发和测试，包括结构同步功能、NDC2.0、源端检查功能、双向同步功能、数据库单元化改造、NDC与流计算平台整合等等；
负责NDC的日常运维和答疑，配合DBA使用NDC进行数据迁移、业务单元化改造</p>
<p>网易数据运河(NDC）是网易自研的一套集数据迁移、数据订阅、数据实时同步于一体的数据传输服务。NDC支持同步的系统包括传统的关系型数据库（OLTP）和大数据系统（OLAP）。自2016年上线以来，NDC平台已经前后创建了上万个同步、订阅任务，同时运行的任务数量也超过了一千个，这些任务帮助网易云音乐、考拉海购、传媒在内的诸多业务完成了数据迁移、数据同步、单元化改造、业务解耦等需求。</p>
<p>在NDC源端检查功能中，NDC管控节点需要周期性（1分钟）检查所有源端DDB数据库的表策略，从而及时做出自动化适配，在功能发布到线上环境后，发现线上数据库需要经过10分钟以上才能发现</p>
<p>为什么做单元化：</p>
<ul>
<li>单机房资源瓶颈</li>
<li>随着业务体量和服务用户群体的增长，单机房或同城双机房无法支持服务的持续扩容。</li>
<li>服务异地容灾</li>
<li>异地容灾已经成为核心服务的标配，有的服务虽然进行了多地多机房部署，但数据还是只在中心机房，实现真正意义上的异地多活，就需要对服务进行单元化改造。</li>
<li>数据就近访问</li>
</ul>
<p>异地多活：竞品</p>
<p>阿里系：高德、饿了么DRC（Data Replicate Center），</p>
<p>回环复制：</p>
<p>标记事务的方式（事务执行之前添加一个update/insert语句），性能损耗大，不方便查看数据变更的机房信息</p>
<p>https://zhuanlan.zhihu.com/p/34958596</p>
<p>冲突解决：保留最大时间戳机制（与NDC类似）</p>
<p>数据校验：依赖其他系统（DBA checkSum）</p>
<p>携程异地多活方案：</p>
<p>DRC（Data Replicate Center）</p>
<p>回环复制：GTID serverId标记事务，性能优秀，但是只能支持MySQL</p>
<p>冲突解决：保留最大时间戳机制（与NDC类似）</p>
<p>DDL方案：和NDC一致（支持忽略字段）</p>
<p>领先：数据一致性兜底方案（实时校验）</p>
<p>竞品</p>
<p>社区flink-cdc-connector，袋鼠云flinkx</p>
<p>每个flink任务要独立到</p>
<p>问题：没有方案做到不同流计算任务之间共享拉取binlog</p>
<p>NDC批量回退功能</p>
<p>提升有效工作时间和工作效率</p>
<p>NDC运维文档化、规范化</p>
<p>面试创新型问题：</p>
<p>1.场景描述：</p>
<p>数据库增量复制的场景：</p>
<p>任务（一个进程，部署在服务器A）将数据库（MySQL，部署在另外一台服务器B）的二进制日志存储到本地磁盘，再从磁盘读出，将内容解析成json格式，过滤掉用户不需要的数据，发送给用户。</p>
<p>数据库日志增长很快，任务很多了（1000+）任务，哪个环节可能成为瓶颈？</p>
<p>磁盘成为瓶颈</p>
<p>网络成为瓶颈</p>
<p>cpu成为瓶颈</p>
<p>有什么优化方案？</p>
<p>2.分库分表的场景：</p>
<p>分库分表的时候需要考虑什么指标？需要达成什么效果？</p>
<p>3.双向数据同步可能面临的问题</p>
<p>1.Hive丢数据定位：</p>
<p>全量分区表</p>
<p>java.sql.SQLException: gtid pieces compare result is different. </p>
<p>9664fdb0-cca7-11ea-b094-6c92bfccde94:1-90718607,</p>
<p>e8a89360-2612-11eb-bf4e-6c92bfccde94:1-139057247,</p>
<p>5a391369-27e5-11eb-8b14-6c92bfcce588:1-3016,</p>
<p>0c59d27d-cca8-11ea-9da1-6c92bfcce4a8:1-3782028,</p>
<p>5da35031-c201-11e8-b751-246e96b59368:1-146799327 </p>
<p>with </p>
<p>9664fdb0-cca7-11ea-b094-6c92bfccde94:1-90718607,</p>
<p>e8a89360-2612-11eb-bf4e-6c92bfccde94:1-139053643,</p>
<p>5a391369-27e5-11eb-8b14-6c92bfcce588:1-3017,</p>
<p>0c59d27d-cca8-11ea-9da1-6c92bfcce4a8:1-3782028,</p>
<p>5da35031-c201-11e8-b751-246e96b59368:1-146799327</p>
<p>e8a89360-2612-11eb-bf4e-6c92bfccde94</p></div>
        
        
    </div>

    
      <footer class="col-md-12 text-center">
          
          
            <hr>
            <p>
            <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</small>
            </p>
          

          
          
      </footer>
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="../js/bootstrap-3.0.3.min.js"></script>

    
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/highlight.min.js"></script>
        
    <script>hljs.initHighlightingOnLoad();</script>
    

    <script>var base_url = ".."</script>
    
    <script src="../js/base.js"></script>

    <div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    </body>

</html>
