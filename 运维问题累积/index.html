<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="记录工作和学习文档">
    
    
    <link rel="shortcut icon" href="../img/favicon.ico">

    
    <title>运维问题累积 - 我的笔记</title>
    

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/v4-shims.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css">
    <link href='//rsms.me/inter/inter.css' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="../css/base.min.css" rel="stylesheet">
    <link href="../css/cinder.min.css" rel="stylesheet">

    
        
        <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/styles/github.min.css">
        
    

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    

     
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            
              <a class="navbar-brand" href="..">我的笔记</a>
            
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../keymap/">快捷方式</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">文章 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">大数据</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E5%A4%A7%E6%95%B0%E6%8D%AE/alluxio/">Alluxio</a>
</li>

        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E5%A4%A7%E6%95%B0%E6%8D%AE/hudi/">Hudi</a>
</li>

        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E5%A4%A7%E6%95%B0%E6%8D%AE/spark-streaming/">Spark</a>
</li>

        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E5%A4%A7%E6%95%B0%E6%8D%AE/yarn/">Yarn</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">数据库</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%80%E6%9C%AF/Canal%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">Canal</a>
</li>

        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%80%E6%9C%AF/LogMiner/">LogMinor</a>
</li>

        
            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">MySQL</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%80%E6%9C%AF/MySQL%20GTID%20set%E5%A4%84%E7%90%86%E6%8A%80%E6%9C%AF/">GTID</a>
</li>

        
    </ul>
  </li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">日记</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E6%97%A5%E8%AE%B0/A-Voyager_%E8%B5%B7%E8%88%AA/">起航</a>
</li>

        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E6%97%A5%E8%AE%B0/Diary-%E8%88%AA%E8%A1%8C%E6%97%A5%E5%BF%97/">航行日志</a>
</li>

        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E6%97%A5%E8%AE%B0/Engine-1_%E5%86%A5%E6%83%B3%E4%BD%93%E6%82%9F/">Engine1-冥想</a>
</li>

        
            
<li >
    <a href="../%E6%96%87%E7%AB%A0/%E6%97%A5%E8%AE%B0/Engine-3_%E5%B1%80%E5%A4%96%E4%BA%BA/">Engine3-局外人</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">java <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../%E6%96%87%E7%AB%A0/java%E6%8A%80%E6%9C%AF/idea/">IDEA</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../ToDo/">ToDo</a>
                    </li>
                
                
                
                    <li >
                        <a href="https://github.com/arcticXXX">GitHub</a>
                    </li>
                
                
                </ul>

            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#2kafka">2.写入kafka报超时</a></li>
        <li class="first-level "><a href="#3">3.启动任务报错</a></li>
            <li class="second-level"><a href="#31">3.1 创建进程失败</a></li>
                
            <li class="second-level"><a href="#32-pullernpe">3.2 puller报NPE</a></li>
                
        <li class="first-level "><a href="#4">4.全量丢数据排查</a></li>
        <li class="first-level "><a href="#5">5.端口号获取进程号和源端</a></li>
        <li class="first-level "><a href="#6">6.预检查报错</a></li>
        <li class="first-level "><a href="#7">7.审计日志</a></li>
        <li class="first-level "><a href="#8duplidate-record">8.增量Duplidate record</a></li>
        <li class="first-level "><a href="#9">9.磁盘打满</a></li>
        <li class="first-level "><a href="#10ndczookeeper">10.NDC高可用zookeeper信息</a></li>
        <li class="first-level "><a href="#11iptables">11.制造网络异常iptables</a></li>
        <li class="first-level "><a href="#12ndc">12.NDC权限管理</a></li>
        <li class="first-level "><a href="#13ndp">13.NDP构建失败</a></li>
        <li class="first-level "><a href="#14">14.增量延迟</a></li>
        <li class="first-level "><a href="#16">16.计费标准</a></li>
        <li class="first-level "><a href="#17isql">17.连接isql后如何切换模式</a></li>
        <li class="first-level "><a href="#18macisql">18.mac连接isql优化命令行工具</a></li>
        <li class="first-level "><a href="#190001-0001-01-000000">19.0001-0001-01 00:00:00的问题</a></li>
        <li class="first-level "><a href="#20chromehttp">20.Chrome浏览器http提交的信息不安全：</a></li>
        <li class="first-level "><a href="#21">21.创建子进程超时</a></li>
        <li class="first-level "><a href="#22">22.全量分区表和增量备份表</a></li>
        <li class="first-level "><a href="#23">23.浏览器截长图</a></li>
        <li class="first-level "><a href="#24oraclemysqlddb">24.Oracle同步到MySQL/DDB丢数据</a></li>
        <li class="first-level "><a href="#25hdfshdfs">25.到HDFS预检查卡在“HDFS权限及分区检查“</a></li>
        <li class="first-level "><a href="#26">26.启动子进程超时</a></li>
            <li class="second-level"><a href="#261-1engine">26.1 场景1：engine配置的子进程端口范围用光</a></li>
                
        <li class="first-level "><a href="#27ddbdbi-aserver">27.连接DDB报错：DBI初始化失败, AServer未启动完成</a></li>
        <li class="first-level "><a href="#28id">28.确认进程id对应的任务</a></li>
        <li class="first-level "><a href="#29ndc-source">29.NDC Source例子</a></li>
        <li class="first-level "><a href="#30ndc">30.NDC订阅数据格式说明</a></li>
        <li class="first-level "><a href="#31_1">31.升级兼容性问题</a></li>
            <li class="second-level"><a href="#311-flick">31.1 flick兼容性的基本原则</a></li>
                
            <li class="second-level"><a href="#312">31.2 比较典型的不兼容的场景</a></li>
                
            <li class="second-level"><a href="#313">31.3 一个比较少见的报错</a></li>
                
        <li class="first-level "><a href="#32">32.创建同步任务报错任务名称重复</a></li>
        <li class="first-level "><a href="#33">33.申请远程工具权限</a></li>
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h2 id="2kafka">2.写入kafka报超时<a class="headerlink" href="#2kafka" title="Permanent link">&para;</a></h2>
<p>Batch Expired
原因1:
partition数量不足
查看topic：./kafka-topics.sh &ndash;zookeeper music-kafka-test1.service.163.org:2181,music-kafka-test2.service.163.org:2181,music-kafka-test3.service.163.org:2181/kafka_test2 &ndash;topic KSong_UserAuth_Search &ndash;describe
增加partition到2: ./kafka-topics.sh &ndash;alter &ndash;topic KSong_UserAuth_Search &ndash;zookeeper music-kafka-test1.service.163.org:2181,music-kafka-test2.service.163.org:2181,music-kafka-test3.service.163.org:2181/kafka_test2 &ndash;partitions 2</p>
<p>通过broker地址增加partition：</p>
<p>补充：
创建topic
./kafka-topics.sh &ndash;create &ndash;zookeeper localhost:2181 &ndash;replication-factor 3 &ndash;partitions 3 &ndash;topic test
kafka客户端 10.120.196.86
cd ~/kafka_2.10-0.10.0.1/bin</p>
<h2 id="3">3.启动任务报错<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<h3 id="31">3.1 创建进程失败<a class="headerlink" href="#31" title="Permanent link">&para;</a></h3>
<p>create executor failed: Failed to start independent proc&hellip;
原因：
机器创建子进程超时
方案：
尝试重启任务（多次）</p>
<h3 id="32-pullernpe">3.2 puller报NPE<a class="headerlink" href="#32-pullernpe" title="Permanent link">&para;</a></h3>
<p>com.netease.dts.engine.tool.IndependentFactoryUtil.copyFile(IndependentFactoryUtil.java:169) ~[dts-engine-2.4.2-SNAPSHOT.jar:2.4.2-SNAPSHOT]
复制logback.xml配置文件失败
确认IndependentFactoryUtil类的ClassLoader的目录是否还在（比如engine在另外一个目录发布，原目录被删除）</p>
<h2 id="4">4.全量丢数据排查<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<p>最可能丢数据的场景有几个，可以排除一下
a.目标端有NDC之外用户的操作，或运维操作
查询历史sql（公司内部rds支持下列sql）
select * from sys.x$statement_analysis where query like &lsquo;DROP%&rsquo; limit 10\G
b.目标端唯一索引和源端不同，导致多行数据发生聚合
c.源端DDB有扩容等运维操作
d.DDB表均衡字段是字符串类型，目标表修改了分区策略，唯一索引中存在特殊字符（如ţ）
原来落在不同节点上的数据，落在了同一个节点上，特殊字符触发了唯一索引冲突，解决冲突的过程会多删数据
处理方案：show collation; 目标端唯一索引的collation改成对应的utf8mb4_bin或utf8_bin</p>
<h2 id="5">5.端口号获取进程号和源端<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<p>netstat -nap | grep 29612</p>
<p>结果如：</p>
<p>tcp6       0      0 h156957.jd.163.org:7102 dts3.jd.163.org:22876   ESTABLISHED 12443/java</p>
<p>12443是PID</p>
<h2 id="6">6.预检查报错<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<p>ERROR 3098 (HY000): The table does not comply with the requirements by an external plugin.
是否开启了MGR，是否是MyISAM表？MGR只支持Innodb表</p>
<h2 id="7">7.审计日志<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<p><em>new_event</em>代表EventGraphManager线程（单）处理NEW类型的event的平均处理时间（ns）和处理速度event/s</p>
<p><em>new_independent</em>是new_event的子集，统计的对象是NEW类型且不被graph阻塞的event</p>
<p><em>slave_queue_size</em>代表slave_queue的平均大小，sps是统计速度（执行DML event的速度）</p>
<p><em>event_count</em>代表整个EventGraphManager中所有event的平均个数，sps是统计速度（执行DML event的速度）</p>
<p><em>old_thread</em>的sps代表由下游已有worker线程处理的event的速度event/s，avg没有含义</p>
<p><em>new_thread</em>的sps代表由下游新申请的worker线程处理的event的速度event/s，avg没有含义，如果没有则表示全部有已有线程处理（new_thread存在说明瓶颈不在写入目标端）</p>
<p><em>graph size</em>是图的个数，每张图对应源端或目标端的一个唯一性索引</p>
<p><em>rows</em>代表图中affectedRows的总个数</p>
<p><em>maxListSize</em>代表row后队列的最大长度</p>
<p><em>maxLeader</em>代表最长队列的队首event信息，包括graph名称（源/目标标识.库名.表名.索引名）和event包含的值</p>
<p><em>LogEventNew</em>统计的不包含等待mysql发送binlog的时间</p>
<p><em>IncReplApplierWrapper</em>和<em>MySQLExtractorNew</em>统计的包含等待mysql发送binlog的时间</p>
<h2 id="8duplidate-record">8.增量Duplidate record<a class="headerlink" href="#8duplidate-record" title="Permanent link">&para;</a></h2>
<p>已知的两个场景：
场景一：目标端任一唯一索引在源端不唯一，即根据冲突的唯一索引值，从源端查到两行数据且他们的均衡字段值不同
处理：是存量数据引发的，一般要求业务修复源端数据后再同步
场景二：全量同步过程中，源端某行数据（唯一索引对应的一行数据）均衡字段发生了变化
处理：去目标端手动删除冲突数据再同步，如果数据量很多，由于和业务操作有关，没有好的处理方式</p>
<p>特殊情况：
上述两个场景如果是单表策略，可以从系统库将均衡字段删除，当成mysql表进行同步，可以避免这个问题
update mig_pipeline set balanceColumnNames = NULL  where jobId = XXX and pipelineId = XXX；</p>
<h2 id="9">9.磁盘打满<a class="headerlink" href="#9" title="Permanent link">&para;</a></h2>
<p>pidstat -d 10 每隔10s统计一次所有进程的磁盘io，退出时计算统计平均值
05:43:25 PM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s  Command
05:43:45 PM  7223      2860      0.00      5.20      1.20  java</p>
<p>根据进程PID获取进程信息
ps -aux | grep 2860</p>
<h2 id="10ndczookeeper">10.NDC高可用zookeeper信息<a class="headerlink" href="#10ndczookeeper" title="Permanent link">&para;</a></h2>
<p>get /online_v2/dts/center/leader/_c_d0f6b675-b1e7-4874-ad56-07dc480dd182-latch-0000139568
{&ldquo;host&rdquo;:&rdquo;10.196.83.85&rdquo;,&rdquo;port&rdquo;:5682,&rdquo;timeout&rdquo;:5000,&rdquo;connectTimeout&rdquo;:3000}
cZxid = 0x40000042a
ctime = Mon Apr 13 15:32:41 CST 2020
mZxid = 0x40000042a
mtime = Mon Apr 13 15:32:41 CST 2020
pZxid = 0x40000042a
cversion = 0
dataVersion = 0
aclVersion = 0
ephemeralOwner = 0x21717fc633e009f
dataLength = 72
numChildren = 0</p>
<p>其中ephemeralOwner = 0x21717fc633e009f 与center日志中的
Session establishment complete on server 10.120.196.84/10.120.196.84:2181, sessionid = 0x21717fc633e009f, negotiated timeout = 5000
相对应</p>
<h2 id="11iptables">11.制造网络异常iptables<a class="headerlink" href="#11iptables" title="Permanent link">&para;</a></h2>
<p>iptables -I OUTPUT -o eth1 -p tcp -d 10.122.173.167 &ndash;dport 3306 -j DROP
删除
iptables -L OUTPUT &ndash;line-numbers
iptables -D OUTPUT 1</p>
<h2 id="12ndc">12.NDC权限管理<a class="headerlink" href="#12ndc" title="Permanent link">&para;</a></h2>
<p>开通权限</p>
<p>grant SUPER,REPLICATION CLIENT,REPLICATION SLAVE on <em>.</em> TO &lsquo;sys&rsquo;@&rsquo;%&rsquo; WITH GRANT OPTION;
flush privileges;</p>
<p>回收权限</p>
<p>revoke SUPER,REPLICATION CLIENT,REPLICATION SLAVE on <em>.</em> from &lsquo;sys&rsquo;@&rsquo;%&rsquo; WITH GRANT OPTION;
flush privileges;</p>
<h2 id="13ndp">13.NDP构建失败<a class="headerlink" href="#13ndp" title="Permanent link">&para;</a></h2>
<p>没有构建失败的日志，配置-集群配置-构建服务器，切换一台构建服务器尝试</p>
<h2 id="14">14.增量延迟<a class="headerlink" href="#14" title="Permanent link">&para;</a></h2>
<p>场景一：延迟时间稳定在某个值，文件位置很接近，可能是mysql机器时间和NDC机器时间不统一造成的
场景二：延迟时间缓慢增大，文件位置很接近，可能是主从复制延迟造成的</p>
<h2 id="16">16.计费标准<a class="headerlink" href="#16" title="Permanent link">&para;</a></h2>
<p><img alt="image-20210527193328884" src="/Users/wangtao/notes/image-20210527193328884-2115325.png" /></p>
<p>NDC按照任务实际运行时长收费（任务状态为“运行中”）</p>
<p>同步任务，每个进程0.263元/小时，即2304元/年（365天24小时连续运行）</p>
<p>订阅任务，每个进程0.395元/小时，即3456元/年（365天24小时连续运行）</p>
<p>每个任务进程数量计算：</p>
<p>一个Oracle/MySQL为源的任务，进程数量=1</p>
<p>一个DDB为源的任务，进程数量=底层MySQL实际个数</p>
<p>任务个数计算：</p>
<p>一个任务可以同步/订阅一个数据库实例的多张表，在这个基础上，业务根据自己的隔离性需求，可以继续拆分成多个任务</p>
<h2 id="17isql">17.连接isql后如何切换模式<a class="headerlink" href="#17isql" title="Permanent link">&para;</a></h2>
<p>use all</p>
<p>use dba</p>
<p>执行use all之后可以清理数据</p>
<h2 id="18macisql">18.mac连接isql优化命令行工具<a class="headerlink" href="#18macisql" title="Permanent link">&para;</a></h2>
<p>为了解决isql客户端不能使用方向键等问题</p>
<p>brew install libreadline-java</p>
<p>最终安装位置类似于：/usr/local/Cellar/libreadline-java/0.8.0_2/lib</p>
<p>将上述路径设置到isql.sh脚本中</p>
<p>vim isql.sh</p>
<pre><code>#!/bin/bash
export LANG=zh_CN.GBK
. setclasspath.sh
java -Dconfigdb=jdbc:mysql://172.21.0.10:3306/dbcm?user=dbcm_read\&amp;password=dbcm_read -Djava.library.path=/usr/local/Cellar/libreadline-java/0.8.0_2/lib com.netease.ddb.tool.iSql &quot;$@&quot;
</code></pre>
<p>然后就可以使用了</p>
<p>./isql.sh -h10.122.173.157 -o8888 -usys -pnetease -F true</p>
<h2 id="190001-0001-01-000000">19.0001-0001-01 00:00:00的问题<a class="headerlink" href="#190001-0001-01-000000" title="Permanent link">&para;</a></h2>
<p>0000-00-00 00:00:00时间同步jdbc查询会报错，为了绕开这个问题，在连接串中添加zeroDateTimeBehavior=round配置，这样查询0000-00-00 00:00:00不会报错，但是会返回0001-01-01 00:00:00，为了保证数据一致性，NDC将查询到的0001-01-01 00:00:00再次转化为0000-00-00 00:00:00同步到目标端，但是这也会造成<strong>源端原本的0001-01-01 00:00:00同步到目标端后被错误地转化成0000-00-00 00:00:00</strong>。</p>
<p><em>订阅任务处理的方式不太相同，将0001-01-01 00:00:00转化为null，因此源端的0000-00-00 00:00:00/0001-01-01 00:00:00都会转化成null发送。（待确认）</em></p>
<p>http://jira.netease.com/browse/DSCDTS-1914?jql=project%20%3D%20DSCDTS</p>
<h2 id="20chromehttp">20.Chrome浏览器http提交的信息不安全：<a class="headerlink" href="#20chromehttp" title="Permanent link">&para;</a></h2>
<p>https://it.netease.com/document/index.html#/document/article/1355</p>
<h2 id="21">21.创建子进程超时<a class="headerlink" href="#21" title="Permanent link">&para;</a></h2>
<p>获取可用port的时间：</p>
<p>[INFO ] 16:56:58.933 [main] [DefaultServiceContainer] Register rpc[service/method] com.netease.flick.independent.IndependentServer:shutdown</p>
<p>和</p>
<p>[INFO ] 16:56:58.961 [main] [RpcServerContainer] Flick Rpc server bind at 0.0.0.0:</p>
<p>之间的耗时即获取可用port之间的耗时，测试环境第一次尝试耗时25毫秒，后续尝试不足1毫秒</p>
<h2 id="22">22.全量分区表和增量备份表<a class="headerlink" href="#22" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th></th>
<th>开启全量同步</th>
<th>开启增量同步</th>
</tr>
</thead>
<tbody>
<tr>
<td>全量分区表</td>
<td>进行一次全量数据同步</td>
<td>再进行增量数据同步，后续每天生成一个全量表</td>
</tr>
<tr>
<td>增量备份表</td>
<td>不支持开启全量同步</td>
<td>只同步增量数据</td>
</tr>
</tbody>
</table>
<h2 id="23">23.浏览器截长图<a class="headerlink" href="#23" title="Permanent link">&para;</a></h2>
<p>https://mp.weixin.qq.com/s?__biz=MzAxMzI1MTYyNQ==&amp;mid=100003647&amp;idx=1&amp;sn=f3666f81f96b037fab0cf529fe443b51&amp;chksm=1ba42a792cd3a36f1b9c450f9c28d58336d54bf729331acad5b748ec473e5d0b4d4c392ab772#rd</p>
<h2 id="24oraclemysqlddb">24.Oracle同步到MySQL/DDB丢数据<a class="headerlink" href="#24oraclemysqlddb" title="Permanent link">&para;</a></h2>
<p>表结构规则约定不同引起</p>
<p>情况1：Oracle字符串类型的唯一索引，在MySQL中判断唯一性不区分大小写，导致数据发生聚合，方案：通过collation指定大小写敏感，重新同步数据</p>
<p>情况2：Oracle自增ID=0，MySQL中默认自增不支持写0，方案：修改sql_mode，支持写入0，https://dev.mysql.com/doc/refman/8.0/en/sql-mode.html#sqlmode_no_auto_value_on_zero</p>
<h2 id="25hdfshdfs">25.到HDFS预检查卡在“HDFS权限及分区检查“<a class="headerlink" href="#25hdfshdfs" title="Permanent link">&para;</a></h2>
<p>减小数据合并参数配置，如</p>
<pre><code class="language-properties">set mapreduce.map.memory.mb=4096
set mapreduce.reduce.memory.mb=4096
set mapreduce.map.java.opts=-Xmx4096m
set mapreduce.reduce.java.opts=-Xmx4096m
</code></pre>
<h2 id="26">26.启动子进程超时<a class="headerlink" href="#26" title="Permanent link">&para;</a></h2>
<h3 id="261-1engine">26.1 场景1：engine配置的子进程端口范围用光<a class="headerlink" href="#261-1engine" title="Permanent link">&para;</a></h3>
<p>现象：启动子进程超时且必现</p>
<p>解决方案：将子进程端口范围调大，具体配置在engine.xml的subprocessConfig中</p>
<h2 id="27ddbdbi-aserver">27.连接DDB报错：DBI初始化失败, AServer未启动完成<a class="headerlink" href="#27ddbdbi-aserver" title="Permanent link">&para;</a></h2>
<p>情况1：查看tungsten.log日志，如果有异常如下，说明9900~9999端口全被占了，需要释放占用端口的进程，查找进程方式（定位到puller后，在界面上重启puller即可，不重启puller子进程端口范围不会生效）：</p>
<p>cd $jobLog</p>
<p>cat PULLER.*/independent.index | grep -e &lsquo;=99..,&rsquo; | less -N</p>
<p>cat independent.index | grep -e &lsquo;=99..,&rsquo; | less -N</p>
<pre><code class="language-java">java.io.IOException: Assign requested address failed, hosts[0.0.0.0], ports[6666, 9900~9999]
        at com.netease.backend.db.client.AServer.createServerSock(AServer.java:191)
        at com.netease.backend.db.client.AServer.initAction(AServer.java:116)
        at com.netease.backend.db.common.proc.ProcBase.doRunInit(ProcBase.java:236)
        at com.netease.backend.db.common.proc.ProcBase.runInit(ProcBase.java:209)
        at com.netease.backend.db.common.proc.ProcBase.run(ProcBase.java:92)
</code></pre>
<h2 id="28id">28.确认进程id对应的任务<a class="headerlink" href="#28id" title="Permanent link">&para;</a></h2>
<p>jps -v | grep [pid]</p>
<p>找到 -Dproc_name=DataSubscribe.xxxx....</p>
<h2 id="29ndc-source">29.NDC Source例子<a class="headerlink" href="#29ndc-source" title="Permanent link">&para;</a></h2>
<p>https://opendata.hz.netease.com/magina/job/list?product=da_music&amp;jobId=5218</p>
<h2 id="30ndc">30.NDC订阅数据格式说明<a class="headerlink" href="#30ndc" title="Permanent link">&para;</a></h2>
<p>NDC默认格式</p>
<table>
<thead>
<tr>
<th></th>
<th>oldValue</th>
<th>newValue</th>
</tr>
</thead>
<tbody>
<tr>
<td>INSERT</td>
<td>null</td>
<td>插入的值</td>
</tr>
<tr>
<td>UPDATE</td>
<td>更新前的值</td>
<td>更新后的值</td>
</tr>
<tr>
<td>DELETE</td>
<td>删除的值</td>
<td>null</td>
</tr>
</tbody>
</table>
<h2 id="31_1">31.升级兼容性问题<a class="headerlink" href="#31_1" title="Permanent link">&para;</a></h2>
<h3 id="311-flick">31.1 flick兼容性的基本原则<a class="headerlink" href="#311-flick" title="Permanent link">&para;</a></h3>
<p>可以兼容新增加的成员变量的前提：成员变量的类型是历史版本中已存在的类型</p>
<h3 id="312">31.2 比较典型的不兼容的场景<a class="headerlink" href="#312" title="Permanent link">&para;</a></h3>
<p>比如DataSubscribeJob新增了一个成员变量，类型是一个新引入的枚举类型，center升级后，engine touch center会报错不兼容</p>
<p>解决方案：将成员变量由枚举类型改为String</p>
<h3 id="313">31.3 一个比较少见的报错<a class="headerlink" href="#313" title="Permanent link">&para;</a></h3>
<p>Caused by: java.lang.AssertionError: com.google.gson.JsonIOException: Expect name _t, but actual:JsonReader at line 1 column 99 path $._V.migJobEngineRuntimes[0]._V.pipelineRuntimeMap[0][1].pipelineId</p>
<p>pipelineRuntimeMap的value本来没有实现FlickProtocol接口，后来实现了</p>
<p>解决方案：去掉implement FlickProtocol，否则无法兼容</p>
<h2 id="32">32.创建同步任务报错任务名称重复<a class="headerlink" href="#32" title="Permanent link">&para;</a></h2>
<p>检查发现没有同名的同步任务</p>
<p>解决：检查是否有同名的校验任务（创建同步任务的同时会创建同名的校验任务）</p>
<h2 id="33">33.申请远程工具权限<a class="headerlink" href="#33" title="Permanent link">&para;</a></h2>
<p>工单：https://it.netease.com/workflow/index.html#/apply/qq-remote</p>
<p>mac本机IP地址MAC地址查询：</p>
<p>ifconfig | less</p>
<p>/status: active</p>
<p><img alt="image-20210528101755964" src="https://tinkerer-pic.oss-cn-hangzhou.aliyuncs.com/picgo/image-20210528101755964.png" /></p>
<p>Preparing: SELECT record_id, table_id, catalog_name, db_name, table_name, compact_range, visible_time, commit_time, plan_time, duration, total_file_cnt_before, total_file_size_before, insert_file_cnt_before, insert_file_size_before, delete_file_cnt_before, delete_file_size_before, base_file_cnt_before, base_file_size_before, total_file_cnt_after, total_file_size_after, snapshot_id, total_size, added_files, removed_files, added_records, removed_records, added_files_size, removed_files_size, total_files, total_records, partition_cnt, partitions, base_table_max_file_seqno FROM major_compact_history WHERE (catalog_name = &ldquo;bdmsTest&rdquo; AND db_name = &ldquo;ndc_test_db&rdquo; AND table_name = &ldquo;test_arctic_v2_read_performance_800&rdquo;) LIMIT 1000000 OFFSET 0;</p></div>
        
        
    </div>

    
      <footer class="col-md-12 text-center">
          
          
            <hr>
            <p>
            <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</small>
            </p>
          

          
          
      </footer>
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="../js/bootstrap-3.0.3.min.js"></script>

    
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/highlight.min.js"></script>
        
    <script>hljs.initHighlightingOnLoad();</script>
    

    <script>var base_url = ".."</script>
    
    <script src="../js/base.js"></script>

    <div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    </body>

</html>
