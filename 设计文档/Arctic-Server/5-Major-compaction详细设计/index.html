<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="记录工作和学习文档">
    
    
    <link rel="shortcut icon" href="../../../img/favicon.ico">

    
    <title>5 Major compaction详细设计 - 我的笔记</title>
    

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/v4-shims.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css">
    <link href='//rsms.me/inter/inter.css' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="../../../css/base.min.css" rel="stylesheet">
    <link href="../../../css/cinder.min.css" rel="stylesheet">

    
        
        <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/styles/github.min.css">
        
    

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    

     
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            
              <a class="navbar-brand" href="../../..">我的笔记</a>
            
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../../../keymap/">快捷方式</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">文章 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">大数据</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../%E6%96%87%E7%AB%A0/%E5%A4%A7%E6%95%B0%E6%8D%AE/alluxio/">Alluxio</a>
</li>

        
            
<li >
    <a href="../../../%E6%96%87%E7%AB%A0/%E5%A4%A7%E6%95%B0%E6%8D%AE/hudi/">Hudi</a>
</li>

        
            
<li >
    <a href="../../../%E6%96%87%E7%AB%A0/%E5%A4%A7%E6%95%B0%E6%8D%AE/spark-streaming/">Spark</a>
</li>

        
            
<li >
    <a href="../../../%E6%96%87%E7%AB%A0/%E5%A4%A7%E6%95%B0%E6%8D%AE/yarn/">Yarn</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">数据库</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../%E6%96%87%E7%AB%A0/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%80%E6%9C%AF/Canal%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">Canal</a>
</li>

        
            
<li >
    <a href="../../../%E6%96%87%E7%AB%A0/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%80%E6%9C%AF/LogMiner/">LogMinor</a>
</li>

        
            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">MySQL</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../%E6%96%87%E7%AB%A0/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%80%E6%9C%AF/MySQL%20GTID%20set%E5%A4%84%E7%90%86%E6%8A%80%E6%9C%AF/">GTID</a>
</li>

        
    </ul>
  </li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">日记</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../%E6%96%87%E7%AB%A0/%E6%97%A5%E8%AE%B0/A-Voyager_%E8%B5%B7%E8%88%AA/">起航</a>
</li>

        
            
<li >
    <a href="../../../%E6%96%87%E7%AB%A0/%E6%97%A5%E8%AE%B0/Diary-%E8%88%AA%E8%A1%8C%E6%97%A5%E5%BF%97/">航行日志</a>
</li>

        
            
<li >
    <a href="../../../%E6%96%87%E7%AB%A0/%E6%97%A5%E8%AE%B0/Engine-1_%E5%86%A5%E6%83%B3%E4%BD%93%E6%82%9F/">Engine1-冥想</a>
</li>

        
            
<li >
    <a href="../../../%E6%96%87%E7%AB%A0/%E6%97%A5%E8%AE%B0/Engine-3_%E5%B1%80%E5%A4%96%E4%BA%BA/">Engine3-局外人</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">java <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../../%E6%96%87%E7%AB%A0/java%E6%8A%80%E6%9C%AF/idea/">IDEA</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../../../ToDo/">ToDo</a>
                    </li>
                
                
                
                    <li >
                        <a href="https://github.com/arcticXXX">GitHub</a>
                    </li>
                
                
                </ul>

            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#major-compaction">Major-compaction详细设计</a></li>
        <li class="first-level "><a href="#_1">概述</a></li>
        <li class="first-level "><a href="#major-compaction-plan">Major-compaction Plan</a></li>
            <li class="second-level"><a href="#major-compaction-plan_1">Major compaction Plan的触发机制</a></li>
                
                <li class="third-level"><a href="#1">1.指标定义</a></li>
                <li class="third-level"><a href="#2changebase-files">2.Change/Base files的文件信息的获取方式：</a></li>
            <li class="second-level"><a href="#major-compaction-task">Major-compaction Task划分</a></li>
                
        <li class="first-level "><a href="#major-compaction-execute">Major-compaction Execute</a></li>
        <li class="first-level "><a href="#major-compaction-commit">Major-compaction Commit</a></li>
        <li class="first-level "><a href="#_2">补充：待明确问题：</a></li>
            <li class="second-level"><a href="#1hive">1.兼容Hive表的问题：</a></li>
                
            <li class="second-level"><a href="#2arctic-table">2.arctic table过期/无效文件的清理</a></li>
                
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<p>[toc]</p>
<h2 id="major-compaction">Major-compaction详细设计<a class="headerlink" href="#major-compaction" title="Permanent link">&para;</a></h2>
<p>本文档解决的问题：</p>
<ul>
<li>major compaction 方案设计，包括Plan Commit过程</li>
</ul>
<p>不在本文档解决范围的问题：</p>
<ul>
<li>major compaction文件合并的具体方案和读写过程（task Execute）</li>
</ul>
<p>待确认解决方案的问题：</p>
<ul>
<li>如何兼容Hive表的问题（spark任务的方案）</li>
<li>arctic table过期/无效文件的清理</li>
</ul>
<h2 id="_1">概述<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>采用流任务的方式执行，将major-compaction拆分成若干个可以独立执行的task，交给flink流任务执行，这些task执行完毕后，由arctic-server进行commit。</p>
<h2 id="major-compaction-plan">Major-compaction Plan<a class="headerlink" href="#major-compaction-plan" title="Permanent link">&para;</a></h2>
<h3 id="major-compaction-plan_1">Major compaction Plan的触发机制<a class="headerlink" href="#major-compaction-plan_1" title="Permanent link">&para;</a></h3>
<p>Major compaction Plan的触发由arctic-server调度，基本的方式是根据partition内change files（最新的snapshot）的指标确认判断是否需要执行major-compaction，如果指标满足要求，则执行Plan生成task。</p>
<h4 id="1">1.指标定义<a class="headerlink" href="#1" title="Permanent link">&para;</a></h4>
<p>先要明确的一点是指标的统计范畴，比如表级别、partition级别、node级别，这里选择的是partition级别。</p>
<p>更确切地说，这里的统计范畴指的是，ChangeTable<strong>某个partition内“未合并的Change Files”</strong>和BaseTable最新snapshot的所有base files，如下图中虚线范围内所示的文件，在BaseTable记录了某个partition内已经合并到BaseTable的max file seq（即图中seq=2，含义是：所有seq&lt;=2的Change Files已经都合并到BaseTable），而“<strong>未合并的Change Files</strong>”指的是，Change Files中（指最新的snapshot涵盖的所有Change Files）所有file seq大于max file seq的文件。</p>
<p><em>具体format中如何保存BaseTable每个分区的max file seq待定</em></p>
<p><img alt="image-20210420103727840" src="https://tinkerer-pic.oss-cn-hangzhou.aliyuncs.com/picgo/image-20210420103727840.png" /></p>
<p><em>图 major-compaction示意图</em></p>
<p>指标描述的是“未合并的Change Files”的总大小和碎片化程度，有如下几个参数：</p>
<ul>
<li>delete files大小(compact.major.delete.file.size.bytes*n)：partition内未合并的delete files的总大小，&gt;=则触发</li>
<li>delete files大小占文件总大小的比例(compact.major.delete.file.ratio)：文件总大小为整个partition的base files + 未合并的insert files的总大小，&gt;=则触发，为了避免base files为空时，少量delete files即出发major-compaction，设置一个delete files的最小阈值，如（compact.major.delete.file.size.bytes.lowest*n）</li>
<li>小文件个数(compact.major.small.file.cnt*n)：change table 未合并的文件 + base files中的小文件个数，&gt;=则触发（兜底小文件问题），是否是小文件的判断标准（compact.major.small.file.size.bytes）</li>
<li>最大间隔(compact.major.interval.max)：如果一个partition超过一定时间没有进行major-compaction，则强制执行一次major-compaction</li>
</ul>
<p>另外需要说明的是，上述参数均为node级别，部分参数需要乘以node个数n（与ArcticTable的写入层级相关，如写入第1层，则n=1；写入第3层，则n=4）才能转化成partiton级别的阈值，并保证上述指标与节点个数的无关性</p>
<p>具体来说</p>
<p>对表执行周期性检查（10分钟），对每个partition：</p>
<p>1.如果partiton内没有尚未完成的major-compaction，则根据上述指标判断是否需要需要出发major-compaction</p>
<p>2.否则，如果partition内有正在Execute/Prepared的task，则跳过检查</p>
<p>3.否则，partition内的所有task都处于Init/Pending/Failed状态：此时如果最新的file seq与上述task的相同，则跳过检查。否则，依据最新的chang files进行检查，如果新生成的task可以一一对应（node节点）地覆盖上述task，则将上述task原地修改为最新的task，并将多出来的task也放入队列；否则，跳过检查。</p>
<h5 id="major-compaction_1">无主键表的major-compaction<a class="headerlink" href="#major-compaction_1" title="Permanent link">&para;</a></h5>
<p>上述指标中小文件个数和最大间隔两个指标可以触发无主键表的major-compaction</p>
<p>无主键表的major-compaction只有base files参数，可以视为一种特殊的compaction-task</p>
<h4 id="2changebase-files">2.Change/Base files的文件信息的获取方式：<a class="headerlink" href="#2changebase-files" title="Permanent link">&para;</a></h4>
<p>最简单可靠的方式是arctic-server周期性获取最新的ChangeTable和BaseTable中的所有文件信息，除此之外也应当开放接口，支持change files增量获取，加速compaction的触发。</p>
<p>减少周期性获取的代价，优化点：</p>
<ul>
<li>记录上次检查的ChangeTable snapshot id，两次之间检查之间snapshot版本没有增长，跳过</li>
</ul>
<p>每次周期性检查后，将信息缓存、落入系统库，作为元数据的base</p>
<p>change files增量获取，开放接口，允许上报ChangeTable commit信息</p>
<ul>
<li>如果收到的snapshot id不超过上次检查的snapshot，忽略</li>
<li>否则，记录其中的文件信息，缓存并入库，累加到元数据base中，并更新元数据base的snapshot id</li>
<li>如果文件达到了上述指标，则主动触发一次进入后续触发流程（和一次周期性检查一致）</li>
</ul>
<h3 id="major-compaction-task">Major-compaction Task划分<a class="headerlink" href="#major-compaction-task" title="Permanent link">&para;</a></h3>
<p>Major-compaction的Plan会生成若干Major-compaction-task。</p>
<p>Major-compaction-task是执行文件合并的任务，具体是指：将指定的Change Files和Base Files合并成新的Base Files，写到Base目录下，然后将合并的结果返回arctic-server。</p>
<p>Plan具体方案：</p>
<p>1.文件范围和上面触发讨论的范围一样，即，在一个partition内，包含BaseTable（最新Snapshot）所有的Base Files + ChangeTable（最新Snapshot）”未合并的Change Files“；</p>
<p>2.将BaseTable和ChangeTable的上述文件填入到同一颗树中，如下图所示</p>
<p>3.确定写入层级（ArcticTable的配置项）</p>
<p>4.按照先根遍历的方式，当到达写入层级或者发现节点存在文件时，则将以该节点为根节点的子树划分为一个task，如果子树中没有任何change 文件，则忽略这个task</p>
<p>5.task写入节点：写入层级所在的节点即写入节点</p>
<p><img alt="image-20210426145018969" src="https://tinkerer-pic.oss-cn-hangzhou.aliyuncs.com/picgo/image-20210426145018969.png" /></p>
<p><em>图 major-compaction Plan示意图</em></p>
<table>
<thead>
<tr>
<th>Task</th>
<th>读取文件</th>
<th>写入节点</th>
</tr>
</thead>
<tbody>
<tr>
<td>Task1</td>
<td>base1 insert1 delete1</td>
<td>Node(4,0) Node(4,2)</td>
</tr>
<tr>
<td>Task2</td>
<td>base2 insert2 delete2</td>
<td>Node(4,1) Node(4,3)</td>
</tr>
</tbody>
</table>
<p>需要特别说明的是，上述major-compaction-task的commit具有相关性。因为commit需要将partition下的max file seq设置为本次合并的change files的最大file seq，这表示着<strong>max file seq之前的change files已经全部合并到base files中</strong>，因此需要等plan生成的所有task都完成后，才能一起commit，部分task先提交将破坏上述语意。</p>
<p>如果要major-compaction-task到commit彼此独立，需要将max files seq到记录下沉到node级别，node级别的收益：</p>
<ul>
<li>major-compaction更快生效（要更频繁地提交才可以）</li>
<li>避免某个task失败影响后续其他节点的major-compaction</li>
<li>commit逻辑更简单</li>
</ul>
<p>问题：</p>
<ul>
<li>理论上不同node的数据是均衡的（hash），单独维护每个node的meta收益有限</li>
<li>Plan复杂度提高</li>
</ul>
<h2 id="major-compaction-execute">Major-compaction Execute<a class="headerlink" href="#major-compaction-execute" title="Permanent link">&para;</a></h2>
<p>Task具体执行方案（吴磊），本文档略</p>
<p>包括Base的目录组织问题，目前方案是合并后的文件直接写到Base原来的分区目录下</p>
<h2 id="major-compaction-commit">Major-compaction Commit<a class="headerlink" href="#major-compaction-commit" title="Permanent link">&para;</a></h2>
<p>有专门负责commit的线程池，对每张表周期性执行提交（允许每张表配置自己的提交周期，默认5分钟），这里的提交是指BaseTable上的MajorCompact操作（文件替换），每次提交时，如果Plan生成的一组相关联的task已经全部执行完成（prepared），则将这组task提交，如果有多组task，将多组task一起提交，提交的内容：</p>
<ul>
<li>需要覆盖的文件列表</li>
<li>覆盖之后的文件列表</li>
<li>max file seq（取多个task的最大值）</li>
</ul>
<h2 id="_2">补充：待明确问题：<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="1hive">1.兼容Hive表的问题：<a class="headerlink" href="#1hive" title="Permanent link">&para;</a></h3>
<p>方案：hive目录和BaseTable目录拆开，BaseTable到hive目录的同步，交给spark任务来做</p>
<p>已知metaV2下目录结构设计：</p>
<table>
<thead>
<tr>
<th>目录</th>
<th>路径</th>
</tr>
</thead>
<tbody>
<tr>
<td>Arctic根目录</td>
<td>./</td>
</tr>
<tr>
<td>Arctic metadata</td>
<td>./metadata</td>
</tr>
<tr>
<td>hive 表分区目录</td>
<td>./partition_hive_xxxx</td>
</tr>
<tr>
<td>BaseTable 根目录</td>
<td>./base</td>
</tr>
<tr>
<td>BaseTable metadata</td>
<td>./base/metadata</td>
</tr>
<tr>
<td>BaseTable 分区目录</td>
<td>./base/partition_base_xxxx</td>
</tr>
<tr>
<td>ChangeTable 根目录</td>
<td>./change</td>
</tr>
<tr>
<td>ChangeTable metadata</td>
<td>./change/metadata</td>
</tr>
<tr>
<td>ChangeTable 分区目录</td>
<td>./change/partition_change_xxx</td>
</tr>
</tbody>
</table>
<p>Hive表的分区目录在Arctic表根目录下，和Base表的目录是区分开的，因此上述major-compaction对Hive表数据不产生影响。</p>
<p>metaV2 base表是iceberg表，这对兼容Hive带来的代价是需要额外保存一份数据给Hive用。</p>
<p>兼容Hive要解决的几个问题：</p>
<p>1.写入hive分区数据的来源（Base? /Base + Change?）</p>
<p>2.谁、什么时候写hive数据</p>
<p>3.写入hive数据什么时候怎么生效</p>
<p>无主键的表：</p>
<p>1.写入hive分区数据的来源</p>
<p>Base</p>
<p>2.谁、什么时候写hive数据</p>
<p>major-compaction生成的文件直接双写到Hive目录下</p>
<p>3.写入hive数据什么时候怎么生效</p>
<p>直接生效（hive如何避免读取正在写入的文件的？.或_开头的文件不可见？）</p>
<p>有主键的表：</p>
<p>1.写入hive分区数据的来源（Base? /Base + Change?）</p>
<p>Base（简单），Base+Change（彻底解耦Major-compaction和hive文件）</p>
<p>2.谁、什么时候写hive数据</p>
<p>flink流任务，一个特殊的task（读取文件，写入hive临时目录）</p>
<p>3.写入hive数据什么时候怎么生效</p>
<p>hive临时目录数据准备完成后，执行hive sql将hive partition指向新的目录（或者目录重命名？）</p>
<h3 id="2arctic-table">2.arctic table过期/无效文件的清理<a class="headerlink" href="#2arctic-table" title="Permanent link">&para;</a></h3>
<p>和major-compaction解耦，作为一个单独的功能</p>
<p>能否使用iceberg表自带的过期清理逻辑，ArcticTable提供接口</p>
<p>需要注意过期文件如果过多，删除过程可能会OOM</p>
<p>目前time-travel功能使用的场景比较少，可以考虑将过期时间设置短一些，也尽可能避免删除OOM的问题</p></div>
        
        
    </div>

    
      <footer class="col-md-12 text-center">
          
          
            <hr>
            <p>
            <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</small>
            </p>
          

          
          
      </footer>
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="../../../js/bootstrap-3.0.3.min.js"></script>

    
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/highlight.min.js"></script>
        
    <script>hljs.initHighlightingOnLoad();</script>
    

    <script>var base_url = "../../.."</script>
    
    <script src="../../../js/base.js"></script>

    <div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    </body>

</html>
